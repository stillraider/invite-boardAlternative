var commandManager,app=app||{},qad=window.qad||{};function InitQuestion(){joint.dia.Element.define("qad.Question",{ports:{groups:{in:{id:"in",position:{name:"left",args:{x:"-3",y:"82"}},attrs:{".back":{pointerEvents:"none",fill:"#ffd6d6",width:"24",height:"24",x:22,rx:4,ry:4},"#port-in":{magnet:"passive",fill:"transparent",width:"50",height:"24"},"#highlight":{display:"none",pointerEvents:"none",fill:"#FEB663",width:"30",height:"30",y:-3,x:19,rx:7,ry:7},image:{pointerEvents:"none"}},markup:'<rect id="port-in"/>',label:{markup:'<rect id="highlight" /><rect class="back"/><image width="14" height="10" style="transform: matrix(-1,0,0,1,42,7)" xlink:href="img/board/Union.svg"/>'}},out:{position:{args:{x:330}},attrs:{".back":{pointerEvents:"all",magnet:!0,fill:"#ffd6d6",width:"24",height:"24",rx:4,ry:4},"#connector":{pointerEvents:"none",fill:"transparent",width:"75",height:"24"},image:{pointerEvents:"none"}},label:{position:{args:{x:5,y:3}},markup:'<image width="14" height="10" xlink:href="img/board/Union.svg"/>'},markup:'<rect class="back"/><rect id="connector"/>'}}},attrs:{".":{magnet:!1},"#header-logo":{display:"block"},"#header-logo rect":{fill:"#fff",width:57,height:50,rx:"6",ry:"6"},"#header-logo text":{fill:"#1CCF64",fontFamily:"Nunito-Black",x:12,y:20,fontSize:13},"#header #number":{fill:"#998A8A",fontFamily:"Nunito-Bold",x:10,y:48,fontSize:12},"#main-back":{fill:"#fff",refWidth:"100%",refHeight:"100%",y:30,refHeight2:"-30",filter:"url(#dropshadow)",rx:"7",ry:"7"},"#header #play":{event:"element:play",refX:"50%",refX2:"-8",y:40,width:16,height:19,cursor:"pointer"},"#header #remove":{event:"element:delete",refDx:-17,y:38,width:10,height:9,cursor:"pointer"},"#header #untitle":{x:32,y:88,fill:"#999999",fontFamily:"Nunito-Regular",fontSize:18,lineHeight:"24",letterSpacing:"-0.3"},"#header #question-title":{x:32,y:116,fontFamily:"Nunito-SemiBold",fontSize:18,lineHeight:24},"#header rect":{fill:"#F0E6E6",y:146,refWidth:1,height:2},"#body #title":{x:32,y:190,fill:"#999999",fontSize:18,lineHeight:24},"#footer #edit rect":{event:"element:edit",fill:"#1d85d0",refX:"50%",refX2:"-42%",refDy:"-80",rx:"6",ry:"6",refWidth:"84%",height:48,cursor:"pointer"},"#footer #edit text":{refX:"50%",refDy:"-50",fill:"#fff",textAnchor:"middle",fontFamily:"Nunito-Bold",fontSize:18,pointerEvents:"none"},text:{fontFamily:"Nunito-Regular",letterSpacing:"-0.3"},".option .subtitle":{fill:"#999999",fontSize:12,x:44,yAlignment:"middle",fontFamily:"Nunito-Bold"},".option .title":{fontSize:14,x:44,yAlignment:"middle",fontFamily:"Nunito-Bold"},".option rect":{refX:"50%",refX2:"-42%",refWidth:"84%",height:52,rx:"6",ry:"6",fill:"#fff",strokeWidth:1,stroke:"#F0E6E6"},"#outline":{display:"none",fill:"transparent",strokeWidth:3,stroke:"#1d85d0",refWidth:"100%",refHeight:"100%",refX:"-10",refY:"-10",rx:"6",ry:"6",refWidth2:"20",refHeight2:"20",pointerEvents:"none"}}},{markup:['<g id="header-logo">',"<rect/>",'<text id="start">Start</text>',"</g>",'<rect id="main-back"/>','<g id="header">','<text id="number">Node №1</text>','<image id="play" xlink:href="img/board/Play.svg"/>','<image id="remove" xlink:href="img/board/cross.svg"/>','<text id="untitle"> Operator phrase: </text>','<text id="question-title"/>',"<rect/>","</g>",'<g id="body">','<text id="title">Response:</text>',"</g>",'<g id="footer">','<g id="edit">',"<rect/>","<text>Click to edit</text>","</g>","</g>",'<g class="options"></g>','<rect id="outline" />'].join(""),optionMarkup:['<g class="option">',"<rect/>",'<text class="subtitle"/>','<text class="title"/>',"</g>"].join(""),initialize:function(){joint.dia.Element.prototype.initialize.apply(this,arguments),this.on("change:options",this.onChangeOptions,this),this.on("change:question",this.onChangeQuestion,this),this.on("change:outline",this.onChangeOutline,this),this.on("change:number",this.onChangeNumber,this),this.on("change:questionHeight",(function(){this.attr(".options/refY",212,{silent:!0})}),this),this.attr(".options/refY",212,{silent:!0}),this.attr("#question-title/text",this.get("question").text,{silent:!0}),this.onChangeOptions()},onChangeQuestion:function(){let t=this.get("question"),e=t.active?"#FFF0BC":"#ffd6d6",i=this.getPorts()[0];null!=i&&"in"==i.group&&(null!=i.attrs&&i.attrs[".back"].fill==e||this.portProp(i.id,"attrs/.back/fill",e));let n=joint.util.measureText(t.text);n!=this.attr("#question-title/text")&&this.attr("#question-title/text",n)},onChangeOptions:function(){var t=this.get("options"),e=0,i={};_.each(t,function(t,n){var o=".option-"+t.id;i[o]={transform:"translate(0, "+e+")",dynamic:!0},i[o+" rect"]={height:50,dynamic:!0},i[o+" .subtitle"]={text:"Option "+(n+1),dynamic:!0,refY:15},i[o+" .title"]={text:joint.util.measureText(t.text),dynamic:!0,refY:33},e+=50;var a=(e+=14)-50+212;this.getPort(t.id)?(this.portProp(t.id,"args/y",a),this.portProp(t.id,"attrs/.back/fill",t.active?"#FFF0BC":"#ffd6d6"),this.portProp(t.id,"attrs/.back/pointerEvents",t.active?"none":"all")):this.addPort({group:"out",id:t.id,args:{y:a}})}.bind(this)),this.attr(i),this.autoresize()},onChangeOutline:function(){let t=this.get("outline");this.attr("#outline/display",t?"block":"none")},onChangeNumber:function(){let t=this.get("number");this.attr("#number/text","Node №"+t)},autoresize:function(){var t=this.get("options")||[],e=50*t.length+14*(t.length-1)+212+100;this.resize(400,e)},applyEdit:function(t){commandManager.initBatchCommand(),_.each(t.remove,function(t){this.removePort(t)}.bind(this)),this.set("options",t.answers),this.set("question",t.question),commandManager.storeBatchCommand()},addOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));e.push(t),this.set("options",e),commandManager.storeBatchCommand()},removeOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));this.removePort(t),this.set("options",_.without(e,_.find(e,{id:t}))),commandManager.storeBatchCommand()},changeOptionActivity:function(t,e){commandManager.initBatchCommand();var i=JSON.parse(JSON.stringify(this.get("options")));i[_.findIndex(i,{id:t})].active=e,this.set("options",i),commandManager.storeBatchCommand()},changeQuestionActivity:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("question")));e.active=t,this.set("question",e),commandManager.storeBatchCommand()},changeOutline:function(t){var e=JSON.parse(JSON.stringify(this.get("outline")));e=t,this.set("outline",e)},changeNumber:function(t){var e=JSON.parse(JSON.stringify(this.get("number")));e=t,this.set("number",e)},applyOptionsAndQuestion:function(t,e){this.set("options",t),this.set("question",e)}})}InitQuestion(),joint.shapes.qad.QuestionView=joint.dia.ElementView.extend({events:{"click #add-answer image":"onAddOption","click .btn-remove-option":"onRemoveOption"},presentationAttributes:joint.dia.ElementView.addPresentationAttributes({options:["OPTIONS"]}),confirmUpdate:function(t){joint.dia.ElementView.prototype.confirmUpdate.apply(this,arguments),this.hasFlag(t,"OPTIONS")&&this.renderOptions()},renderMarkup:function(){joint.dia.ElementView.prototype.renderMarkup.apply(this,arguments),this.$options=this.$(".options"),this.elOption=V(this.model.optionMarkup),this.renderOptions()},renderOptions:function(){this.$options.empty(),_.each(this.model.get("options"),function(t,e){var i="option-"+t.id,n=this.elOption.clone().addClass(i);n.attr("option-id",t.id),this.$options.append(n.node)}.bind(this)),this.update()},onAddOption:function(){this.model.addOption({id:_.uniqueId("option-"),text:"Answer "+(this.model.get("options").length+1),active:!1})},onRemoveOption:function(t){this.model.removeOption(V(t.target.parentNode).attr("option-id"))}}),app.Selection=Backbone.Collection.extend(),app.SelectionView=joint.mvc.View.extend({PADDING:3,BOX_TEMPLATE:V("rect",{stroke:"#C6C7E2","stroke-width":1,"pointer-events":"none"}),init:function(){this.listenTo(this.model,"add reset change",this.render)},render:function(){return _.invokeMap(this.boxes,"remove"),this.boxes=this.model.map(function(t){return this.BOX_TEMPLATE.clone().attr(t.getBBox().inflate(this.PADDING)).appendTo(this.options.paper.cells)}.bind(this)),this},onRemove:function(){_.invokeMap(this.boxes,"remove"),delete this.boxes}}),app.Factory={createQuestion:function(t,e){return new joint.shapes.qad.Question({ports:{items:e?[]:[{group:"in"}]},attrs:{"#header-logo":{display:e?"block":"none"}},position:{x:400,y:250},question:{text:t,active:!1},start:e,outline:!1,number:1,options:[]})},createLink:function(){return new joint.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"#6a6c8a",stroke:"#6a6c8a"},".connection":{stroke:"#6a6c8a",strokeWidth:2},".marker-arrowheads":{display:"none"},".tool-remove":{display:"none"}}})},createDialogJSON:function(t,e){var i={startNode:void 0,nodes:[],links:[]};return _.each(t.getCells(),(function(t){var n={id:t.id,type:t.get("type")};switch(t.get("type")){case"qad.Question":n.question=t.get("question"),n.options=t.get("options"),i.nodes.push(n),e?e==t.id&&(i.startNode=i.nodes.length-1):t.get("start")&&(i.startNode=i.nodes.length-1);break;default:n.source=t.get("source"),n.target=t.get("target"),i.links.push(n)}})),i}};let modePlay=new ModePlay;function ModePlay(){let t=this,e=document.querySelector(".mode-start"),i=e.querySelector(".mode-start__answer"),n=e.querySelector(".mode-start__questions_text"),o=e.querySelector(".mode-start__header_close");function a(){r(!1)}function r(t){e.style.display=t?"flex":"none"}function s(e,o){t.dataNodes=e,o||(o=e.nodes[e.startNode]),function(t){i.textContent="";for(var e=0;e<t.options.length;e++)i.appendChild(d(t.options[e]));n.innerHTML=t.question.text}(o),t.currentNode=o}function d(e){var i,n,o,a=(i="div",n="mode-start__answer_item",(o=document.createElement(i)).setAttribute("class",n),o);a.textContent=e.text;let r=e.id;return a.onclick=function(){!function(e){for(var i,n=0;n<t.dataNodes.links.length;n++){var o=t.dataNodes.links[n];if(o.source.id===t.currentNode.id&&o.source.port===e){i=o;break}}if(i){for(var a,r=0;r<t.dataNodes.nodes.length;r++){var d=t.dataNodes.nodes[r];if(d.id===i.target.id){a=d;break}}a&&s(t.dataNodes,a)}}(r)},a}this.Initialize=function(){o.onclick=a},this.openDialog=function(t,e){let i=app.Factory.createDialogJSON(t,e);i.nodes.length>1&&i.links.length>0&&(r(!0),s(i))}}modePlay.Initialize(),app.AppView=joint.mvc.View.extend({el:".board",events:{"click .board__create-node":"addQuestion","click .board__start":"previewDialog","click #toolbar .code-snippet":"showCodeSnippet","click #toolbar .load-example":"loadExample","click #toolbar .clear":"clear"},init:function(){this.initializePaper()},initializePaper:function(){let t=this;joint.linkTools.mapping={Remove:joint.linkTools.Button.extend({children:[{tagName:"circle",selector:"button",attributes:{r:10,fill:"#f6f6f6",stroke:"#5755a1","stroke-width":2,cursor:"pointer"}},{tagName:"path",selector:"icon",attributes:{d:"M -4 -4 4 4 M -4 4 4 -4",fill:"none",stroke:"#5755a1","stroke-width":4,"pointer-events":"none"}}]})},joint.shapes.standard.Link.define("mapping.Link",{z:-1,attrs:{line:{targetMarker:{type:"path",fill:"#5755a1",d:"M 10 -5 0 0 10 5 z"},stroke:"gray"}}});let e=new joint.dia.Paper({el:this.$("#paper"),width:1500,height:500,gridSize:10,snapLinks:{radius:10},interactive:{vertexAdd:!1,arrowheadMove:!1,useLinkTools:!1},linkPinning:!1,multiLinks:!1,defaultLink:app.Factory.createLink(),defaultRouter:{name:"manhattan",args:{padding:10,maxAllowedDirectionChange:180,perpendicular:!1,startDirections:["right"],endDirections:["left"],maximumLoops:3e3}},defaultConnectionPoint:{name:"boundary",args:{sticky:!0}},defaultConnector:{name:"rounded",args:{radius:7}},validateConnection:function(t,e,i,n,o,a){return(!e||"in"!==e.getAttribute("port-group"))&&(t!==i&&(n&&"in"===n.getAttribute("port-group")||"qad.Question"===t.model.get("type")&&"qad.Answer"===i.model.get("type")))},validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")}});this.paper=e,e.off("cell:highlight"),e.on("cell:highlight",(function(t,e){e.parentNode.querySelector("#highlight").setAttribute("display","block")})),e.on("cell:unhighlight",(function(t,e){e.parentNode.querySelector("#highlight").setAttribute("display","none")}));var i=new joint.ui.PaperScroller({autoResizePaper:!0,padding:1e3,paper:e,cursor:"grab"});function n(t,e,n){i.zoom(.15*n,{min:.4,max:2.5,grid:.1,ox:t,oy:e})}function o(t){i.zoom(.4*t,{min:.4,max:2.5})}function a(e,i){commandManager.initBatchCommand(),e.remove(),t.updatePort(),commandManager.storeBatchCommand()}i.lock(),e.on("blank:pointerdown",i.startPanning),$("#app").append(i.render().el),e.on("link:mouseenter",(function(t){this.removeTools(),function(t){var e=new joint.dia.ToolsView({tools:[new joint.linkTools.mapping.Remove({distance:"92%",action:function(){a(this.model,t)}}),new joint.linkTools.mapping.Remove({distance:"8%",action:function(){a(this.model,t)}})]});t.addTools(e)}(t)})),e.on("blank:mousewheel",(function(t,e,i,o){t.preventDefault(),n(e,i,o)})),e.on("cell:mousewheel",(function(t,e,i,o,a){e.preventDefault(),n(i,o,a)})),$(".zoom-in").on("click",(function(){o(1)})),$(".zoom-out").on("click",(function(){o(-1)})),e.on("link:mouseleave",(function(){this.removeTools()})),e.defs.innerHTML='<filter id="dropshadow"><feDropShadow dx="0" dy="8" stdDeviation="18" flood-color="#000000" flood-opacity="0.08"/></filter>',e.on("link:snap:connect",(function(t,e){e.stopPropagation(),t.targetView.model.changeQuestionActivity(!0),t.sourceView.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!0)})),e.on("link:snap:disconnect",(function(t,e,i,n,o){e.stopPropagation(),null==t.targetView&&(i.model.changeQuestionActivity(!1),t.sourceView.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!1))})),this.graph=e.model,commandManager=new joint.dia.CommandManager({graph:this.graph}),$(".undo").click((function(){commandManager.undo()})),$(".redo").click((function(){commandManager.redo()})),e.on("element:delete",(function(t,e,i,n){e.stopPropagation();let o=0;t.model.remove(),_.each(this.graph.getCells(),(function(t){"qad.Question"==t.get("type")&&(o++,t.changeNumber(o))})),this.updatePort()}),this),e.on("element:edit",(function(t,e,i,n){e.stopPropagation(),editNodeWindow.SetListItems(t.model,this)}),this),e.on("element:play",(function(t,e,i,n){e.stopPropagation(),modePlay.openDialog(this.graph,t.model.id)}),this)},updatePort:function(){let t=this.paper,e={models:[],in:[],out:[]};_.each(this.graph.getCells(),(function(i){if("qad.Question"==i.get("type"))e.models.push(i);else{let n=t.findViewByModel(i);console.log(t),e.out.push(n.sourceMagnet.getAttribute("port")),e.in.push(n.targetMagnet.getAttribute("port"))}})),_.each(e.models,(function(t){let i=t.get("options"),n=t.get("question");if(!t.get("start")){let i=t.getPorts()[0].id;n.active=e.in.includes(i)}_.each(i,(function(t){t.active=e.out.includes(t.id)})),t.applyOptionsAndQuestion(i,n),t.onChangeOptions(),t.onChangeQuestion()}))},addQuestion:function(){let t=0,e=!0;_.each(this.graph.getCells(),function(t){if(t.get("start"))return e=!1,!1}.bind(this)),app.Factory.createQuestion("Question",e).addTo(this.graph),_.each(this.graph.getCells(),(function(e){"qad.Question"==e.get("type")&&(t++,e.changeNumber(t))}))},previewDialog:function(){modePlay.openDialog(this.graph)},clear:function(){this.graph.clear()},showCodeSnippet:function(){var t=this.selection.first(),e=app.Factory.createDialogJSON(this.graph,t),i=_.uniqueId("qad-dialog-"),n="";n+='<div id="'+i+'"></div>',n+='<link rel="stylesheet" type="text/css" href="http://qad.client.io/css/snippet.css"><\/script>',n+='<script type="text/javascript" src="http://qad.client.io/src/snippet.js"><\/script>',n+='<script type="text/javascript">',n+='document.getElementById("'+i+'").appendChild(qad.renderDialog('+JSON.stringify(e)+"))";var o="<textarea>"+(n+="<\/script>")+"</textarea>";new joint.ui.Dialog({width:"50%",height:200,draggable:!0,title:"Copy-paste this snippet to your HTML page.",content:o}).open()}}),joint.util.measureText=function(t){var e=V("svg").node,i=V("<text><tspan></tspan></text>").node,n=i.firstChild,o=document.createTextNode("");n.appendChild(o),e.appendChild(i),document.body.appendChild(e),o.data=t;var a=n.getBBox().width;if(a>220){let i=t.split(""),r="";for(let t=0;t<i.length;t++)if(r+=i[t],o.data=r,(a=n.getBBox().width)>=220)return V(e).remove(),r+"..."}return V(e).remove(),t};let editNodeWindow=new EditNodeWindow;function EditNodeWindow(){let t,e,i,n,o,a=0,r=document.querySelector(".node-edit"),s=r.querySelector(".node-edit__wrapper-item"),d=r.querySelector(".node-edit__header_btn"),l=r.querySelector(".node-edit__save"),c=r.querySelector(".node-edit__play"),p=new function(){let e;this.data={question:{text:""}},this.Initialize=function(t,i){this.data={question:JSON.parse(JSON.stringify(t.get("question"))),answers:JSON.parse(JSON.stringify(t.get("options"))),remove:[]},e=i},this.ApplyEdit=function(){t.applyEdit(this.data),e.updatePort()},this.addAnswer=function(){let t={id:_.uniqueId("option-"),text:"",active:!1};return t.text=t.id,this.data.answers.push(t),t},this.removeAnswer=function(t){this.data.answers=_.without(this.data.answers,_.find(this.data.answers,{id:t})),this.data.remove.push(t)}};function u(){s.innerHTML="",n=null,i=0}function h(t){i++;let n=e.cloneNode(!0);s.appendChild(n),n.querySelector(".node-edit__remove-item").onclick=function(e){e.stopPropagation(),i--,this.parentNode.remove(),p.removeAnswer(t.id)},f(n,t)}function g(e){t.changeOutline(e),r.style.transform="translateX("+(e?0:764)+"px)"}function f(t,e){let i=t.querySelector(".node-edit__item"),o=i.querySelector(".node-edit__item_text"),r=i.querySelector(".node-edit__control_start"),s=i.querySelector(".node-edit__control_cancel"),d="";function l(t){i.style.height=(t||o.offsetHeight)+"px"}function c(t){o.value=u(t),d=e.text,e.text=t}function p(){t.classList.remove("excretionItem")}function u(t){let e,i,n=t.split(" ");!function(){let t=getComputedStyle(o);a=Math.max(a,o.offsetWidth-(parseInt(t.paddingLeft)+parseInt(t.paddingRight))),e=parseInt(t.lineHeight),i=document.createElement("p"),i.style.lineHeight=e+"px",i.style.fontSize=t.fontSize,i.style.fontFamily=t.fontFamily,i.style.display="inline-block",document.body.appendChild(i)}();let r=function(t){if(s(t)>1){let t="",e="";return function(){for(;;){let e=t+n[0]+" ";if(1==s(e))break;n.shift(),t=e}}(),function(){for(;e+=n.shift()+" ",2!=s(t+e););}(),function(){let t=e.split("");e="";for(let n=0;n<t.length;n++){let o=e+t[n];if(d(o)>=a-13){" "==t[n-1]&&(i(),"."==t[n-2]&&i()),"."==t[n-1]&&i();break}e=o}function i(){e=e.slice(0,-1)}}(),t+e+"..."}return t}(t);return i.remove(),r;function s(t){return l(t,!0),i.offsetHeight/e}function d(t){return l(t,!1),i.offsetWidth}function l(t,e){i.innerText=t,i.style.width=e?a+"px":"auto"}}autosize(o),o.addEventListener("autosize:resized",(function(){l()})),s.onclick=function(t){console.log("buttonCancel"),o.value=u(d),e.text=d},o.onfocus=function(i){null!=n&&p(),n=t,t.classList.add("excretionItem"),o.value=e.text,r.style.right="75px",s.style.right="5px",o.style.paddingBottom="35px",autosize.update(o),l(),console.log("onfocus")},o.onblur=function(t){p(),c(o.value),r.style.right="-75px",s.style.right="-145px",o.style.paddingBottom="10px",autosize.update(o),l(52),console.log("onblur")},c(e.text)}this.Initialize=function(){!function(){let t=s.querySelector(".node-edit__inner-item");e=t.cloneNode(!0),u()}(),r.querySelector(".node-edit__add-item").onclick=function(){h(p.addAnswer())},o=document.querySelector(".node-edit__operator").querySelector(".node-edit__inner-item"),d.onclick=l.onclick=function(){p.ApplyEdit(),g(!1)},c.onclick=function(){console.log("play"),modePlay.openDialog(t.graph,t.id)}},this.SetListItems=function(e,i){p.Initialize(e,i),t=e,console.log(t),u(),function(){_.each(p.data.answers,function(t){h(t)}.bind(this))}(),g(!0),f(o,p.data.question)}}editNodeWindow.Initialize(),window.appView=new app.AppView,joint.setTheme("modern");