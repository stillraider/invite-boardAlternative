var commandManager,app=app||{},qad=window.qad||{};function InitQuestion(){joint.dia.Element.define("qad.Question",{ports:{groups:{in:{id:"in",position:{name:"left",args:{x:"-3",y:"62"}},attrs:{".back":{pointerEvents:"none",fill:"#ffd6d6",width:"24",height:"24",x:22,rx:4,ry:4},"#port-in":{magnet:"passive",fill:"transparent",width:"50",height:"24"},"#highlight":{display:"none",pointerEvents:"none",fill:"#FEB663",width:"30",height:"30",y:-3,x:19,rx:7,ry:7},image:{pointerEvents:"none"}},markup:'<rect id="port-in"/>',label:{markup:'<rect id="highlight" /><rect class="back"/><image width="14" height="10" style="transform: matrix(-1,0,0,1,42,7)" xlink:href="img/board/Union.svg"/>'}},out:{position:{args:{x:330}},attrs:{".back":{pointerEvents:"all",magnet:!0,fill:"#ffd6d6",width:"24",height:"24",rx:4,ry:4},"#connector":{pointerEvents:"none",fill:"transparent",width:"75",height:"24"},image:{pointerEvents:"none"}},label:{position:{args:{x:5,y:3}},markup:'<image width="14" height="10" xlink:href="img/board/Union.svg"/>'},markup:'<rect class="back"/><rect id="connector"/>'}},items:[{group:"in"}]},attrs:{".":{magnet:!1},"#header-strat":{display:"block"},"#header-strat #startBorder":{width:38,height:20,rx:"6",ry:"6",x:32,y:7,fill:"transparent",strokeWidth:1,stroke:"#1CCF64"},"#header-strat #start":{fill:"#1CCF64",fontFamily:"Nunito-Black",x:36,y:21,fontSize:12},"#header-end":{display:"none"},"#header-end #endBorder":{width:38,height:20,rx:"6",ry:"6",x:32,y:7,fill:"transparent",strokeWidth:1,stroke:"black"},"#header-end #end":{fill:"black",fontFamily:"Nunito-Black",x:40,y:21,fontSize:12},"#header-control #back":{width:57,height:71,fill:"transparent",x:400,y:0},"#header-control #startNode":{event:"element:setStart",cursor:"pointer"},"#header-control #startNode text":{fill:"black",fontFamily:"Nunito-Black",x:424,y:14,fontSize:12},"#header-control #startNode rect":{width:37,height:20,rx:"6",ry:"6",x:420,y:0,fill:"transparent",strokeWidth:1,stroke:"black"},"#header-control #endNode":{event:"element:setEnd",cursor:"pointer"},"#header-control #endNode text":{fill:"black",fontFamily:"Nunito-Black",x:428,y:39,fontSize:12},"#header-control #endNode rect":{width:37,height:20,rx:"6",ry:"6",x:420,y:25,fill:"transparent",strokeWidth:1,stroke:"black"},"#header-control #add":{event:"element:add",cursor:"pointer"},"#header-control #add rect":{width:37,height:20,x:420,y:50,fill:"transparent",strokeWidth:1,stroke:"black",rx:"6",ry:"6"},"#header-control #add image":{width:13,height:13,x:432,y:54},"#header #number":{display:"none",fill:"#998A8A",fontFamily:"Nunito-Bold",x:10,y:48,fontSize:12},"#main-back":{fill:"#fff",refWidth:"100%",refHeight:"100%",filter:"url(#dropshadow)",rx:"7",ry:"7"},"#header #play":{event:"element:play",refX:"50%",refX2:"-8",y:7,width:16,height:19,cursor:"pointer"},"#header #remove":{event:"element:delete",refDx:-17,y:7,width:10,height:9,cursor:"pointer"},"#header #untitle":{x:32,y:53,fill:"#999999",fontFamily:"Nunito-Regular",fontSize:18,lineHeight:"24",letterSpacing:"-0.3"},"#header #question-title":{x:32,y:80,fontFamily:"Nunito-SemiBold",fontSize:18,lineHeight:24},"#header #border-bottom":{fill:"#F0E6E6",y:107,refWidth:1,height:2},"#body #title":{x:32,y:150,fill:"#999999",fontSize:18,lineHeight:24},"#footer #edit rect":{event:"element:edit",fill:"#1d85d0",refX:"50%",refX2:"-42%",refDy:"-80",rx:"6",ry:"6",refWidth:"84%",height:48,cursor:"pointer"},"#footer #edit text":{refX:"50%",refDy:"-50",fill:"#fff",textAnchor:"middle",fontFamily:"Nunito-Bold",fontSize:18,pointerEvents:"none"},text:{fontFamily:"Nunito-Regular",letterSpacing:"-0.3"},".option .subtitle":{fill:"#999999",fontSize:12,x:44,yAlignment:"middle",fontFamily:"Nunito-Bold"},".option .title":{fontSize:14,x:44,yAlignment:"middle",fontFamily:"Nunito-Bold"},".option rect":{refX:"50%",refX2:"-42%",refWidth:"84%",height:52,rx:"6",ry:"6",fill:"#fff",strokeWidth:1,stroke:"#F0E6E6"},"#outline":{display:"none",fill:"transparent",strokeWidth:3,stroke:"#1d85d0",refWidth:"100%",refHeight:"100%",refWidth2:"20",refHeight2:"20",refX:"-10",refY:"-10",rx:"6",ry:"6",pointerEvents:"none"},"#outlineВotted":{display:"none"},"#outlineВotted #botted":{fill:"transparent",strokeWidth:3,stroke:"#1d85d0",strokeDasharray:"5",refWidth:"100%",refHeight:"100%",refWidth2:"20",refHeight2:"20",refX:"-10",refY:"-10",rx:"6",ry:"6",pointerEvents:"none"}}},{markup:['<g id="outlineВotted">','<rect id="botted"/>','<g id="header-control">','<rect id="back" />','<g id="startNode">',"<rect/>","<text>Start</text>","</g>",'<g id="endNode">',"<rect/>","<text>End</text>","</g>",'<g id="add">',"<rect/>",'<image xlink:href="img/board/add.svg"/>',"</g>","</g>","</g>",'<rect id="main-back"/>','<g id="header">','<g id="header-strat">','<rect id="startBorder" />','<text id="start">Start</text>',"</g>",'<g id="header-end">','<rect id="endBorder" />','<text id="end">End</text>',"</g>",'<text id="number">Node №1</text>','<image id="play" xlink:href="img/board/Play.svg"/>','<image id="remove" xlink:href="img/board/cross.svg"/>','<text id="untitle"> Operator phrase: </text>','<text id="question-title"/>','<rect id="border-bottom"/>',"</g>",'<g id="body">','<text id="title">Response:</text>',"</g>",'<g id="footer">','<g id="edit">',"<rect/>","<text>Click to edit</text>","</g>","</g>",'<g class="options"></g>','<rect id="outline" />'].join(""),optionMarkup:['<g class="option">',"<rect/>",'<text class="subtitle"/>','<text class="title"/>',"</g>"].join(""),initialize:function(){joint.dia.Element.prototype.initialize.apply(this,arguments),this.on("change:options",this.onChangeOptions,this),this.on("change:question",this.onChangeQuestion,this),this.on("change:outline",this.onChangeOutline,this),this.on("change:outlineВotted",this.onChangeOutlineВotted,this),this.on("change:number",this.onChangeNumber,this),this.on("change:startEnd",this.onChangeStartEnd,this),this.on("change:questionHeight",(function(){this.attr(".options/refY",170,{silent:!0})}),this),this.attr(".options/refY",170,{silent:!0}),this.attr("#question-title/text",this.get("question").text,{silent:!0}),this.onChangeOptions()},onChangeQuestion:function(){let t=this.get("question"),e=t.active?"#FFF0BC":"#ffd6d6",n=this.getPorts()[0];null!=n&&"in"==n.group&&(null!=n.attrs&&n.attrs[".back"].fill==e||this.portProp(n.id,"attrs/.back/fill",e));let i=joint.util.measureText(t.text);i!=this.attr("#question-title/text")&&this.attr("#question-title/text",i)},onChangeOptions:function(){var t=this.get("options"),e=0,n={};_.each(t,function(t,i){var o=".option-"+t.id;n[o]={transform:"translate(0, "+e+")",dynamic:!0},n[o+" rect"]={height:50,dynamic:!0},n[o+" .subtitle"]={text:"Option "+(i+1),dynamic:!0,refY:15},n[o+" .title"]={text:joint.util.measureText(t.text),dynamic:!0,refY:33},e+=50;var a=(e+=14)-50+170;this.getPort(t.id)?(this.portProp(t.id,"args/y",a),this.portProp(t.id,"attrs/.back/fill",t.active?"#FFF0BC":"#ffd6d6"),this.portProp(t.id,"attrs/.back/pointerEvents",t.active?"none":"all")):this.addPort({group:"out",id:t.id,args:{y:a}})}.bind(this)),this.attr(n),this.autoresize()},onChangeOutline:function(){let t=this.get("outline");this.attr("#outline/display",t?"block":"none")},"onChangeOutlineВotted":function(){let t=this.get("outlineВotted");this.attr("#outlineВotted/display",t?"block":"none")},onChangeNumber:function(){let t=this.get("number");this.attr("#number/text","Node №"+t)},onChangeStartEnd:function(){let t=this,e=this.get("startEnd");function n(e,n){t.attr("#header-strat/display",e),t.attr("#header-end/display",n)}null==e?n("none","none"):n(e?"block":"none",e?"none":"block")},autoresize:function(){var t=this.get("options")||[],e=50*t.length+14*(t.length-1)+170+100;this.resize(400,e)},applyEdit:function(t){commandManager.initBatchCommand(),_.each(t.remove,function(t){this.removePort(t)}.bind(this)),this.set("options",t.answers),this.set("question",t.question),commandManager.storeBatchCommand()},addOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));e.push(t),this.set("options",e),commandManager.storeBatchCommand()},removeOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));this.removePort(t),this.set("options",_.without(e,_.find(e,{id:t}))),commandManager.storeBatchCommand()},changeOptionActivity:function(t,e){commandManager.initBatchCommand();var n=JSON.parse(JSON.stringify(this.get("options")));n[_.findIndex(n,{id:t})].active=e,this.set("options",n),commandManager.storeBatchCommand()},changeQuestionActivity:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("question")));e.active=t,this.set("question",e),commandManager.storeBatchCommand()},changeOutline:function(t){var e=JSON.parse(JSON.stringify(this.get("outline")));e=t,this.set("outline",e)},"changeOutlineВotted":function(t){var e=JSON.parse(JSON.stringify(this.get("outlineВotted")));e=t,this.set("outlineВotted",e)},changeNumber:function(t){var e=JSON.parse(JSON.stringify(this.get("number")));e=t,this.set("number",e)},changeStartEnd:function(t){this.set("startEnd",t)},applyOptionsAndQuestion:function(t,e){this.set("options",t),this.set("question",e)}})}InitQuestion(),joint.shapes.qad.QuestionView=joint.dia.ElementView.extend({events:{"click #add-answer image":"onAddOption","click .btn-remove-option":"onRemoveOption"},presentationAttributes:joint.dia.ElementView.addPresentationAttributes({options:["OPTIONS"]}),confirmUpdate:function(t){joint.dia.ElementView.prototype.confirmUpdate.apply(this,arguments),this.hasFlag(t,"OPTIONS")&&this.renderOptions()},renderMarkup:function(){joint.dia.ElementView.prototype.renderMarkup.apply(this,arguments),this.$options=this.$(".options"),this.elOption=V(this.model.optionMarkup),this.renderOptions()},renderOptions:function(){this.$options.empty(),_.each(this.model.get("options"),function(t,e){var n="option-"+t.id,i=this.elOption.clone().addClass(n);i.attr("option-id",t.id),this.$options.append(i.node)}.bind(this)),this.update()},onAddOption:function(){this.model.addOption({id:_.uniqueId("option-"),text:"Answer "+(this.model.get("options").length+1),active:!1})},onRemoveOption:function(t){this.model.removeOption(V(t.target.parentNode).attr("option-id"))}}),app.Selection=Backbone.Collection.extend(),app.SelectionView=joint.mvc.View.extend({PADDING:3,BOX_TEMPLATE:V("rect",{stroke:"#C6C7E2","stroke-width":1,"pointer-events":"none"}),init:function(){this.listenTo(this.model,"add reset change",this.render)},render:function(){return _.invokeMap(this.boxes,"remove"),this.boxes=this.model.map(function(t){return this.BOX_TEMPLATE.clone().attr(t.getBBox().inflate(this.PADDING)).appendTo(this.options.paper.cells)}.bind(this)),this},onRemove:function(){_.invokeMap(this.boxes,"remove"),delete this.boxes}}),app.Factory={createQuestion:function(t,e,n,i){return new joint.shapes.qad.Question({attrs:{"#header-strat":{display:e?"block":"none"}},position:{x:n||400,y:i||250},question:{text:t,active:!1},startEnd:e,outline:!1,"outlineВotted":!1,number:1,options:[]})},createLink:function(){return new joint.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"#6a6c8a",stroke:"#6a6c8a"},".connection":{stroke:"#6a6c8a",strokeWidth:2},".marker-arrowheads":{display:"none"},".tool-remove":{display:"none"}}})},createDialogJSON:function(t,e){var n={startNode:void 0,nodes:[],links:[]};return _.each(t.getCells(),(function(t){var i={id:t.id,type:t.get("type")};switch(t.get("type")){case"qad.Question":i.question=t.get("question"),i.options=t.get("options"),n.nodes.push(i),e?e==t.id&&(n.startNode=n.nodes.length-1):t.get("startEnd")&&(n.startNode=n.nodes.length-1);break;default:i.source=t.get("source"),i.target=t.get("target"),n.links.push(i)}})),n}};let modePlay=new ModePlay;function ModePlay(){let t=this,e=document.querySelector(".mode-start"),n=document.querySelector(".mode-start__block"),i=document.querySelector(".mode-start__answer"),o=document.querySelector(".mode-start__questions_text"),a=document.querySelector(".mode-start__header_close");function r(){s(!1)}function s(t){e.style.display=t?"block":"none",n.style.display=t?"block":"none"}function d(e,n){t.dataNodes=e,n||(n=e.nodes[e.startNode]),function(t){i.textContent="";for(var e=0;e<t.options.length;e++)i.appendChild(l(t.options[e]));o.innerHTML=t.question.text}(n),t.currentNode=n}function l(e){var n,i,o,a=(n="div",i="mode-start__answer_item",(o=document.createElement(n)).setAttribute("class",i),o);a.textContent=e.text;let r=e.id;return a.onclick=function(){!function(e){for(var n,i=0;i<t.dataNodes.links.length;i++){var o=t.dataNodes.links[i];if(o.source.id===t.currentNode.id&&o.source.port===e){n=o;break}}if(n){for(var a,r=0;r<t.dataNodes.nodes.length;r++){var s=t.dataNodes.nodes[r];if(s.id===n.target.id){a=s;break}}a&&d(t.dataNodes,a)}}(r)},a}this.Initialize=function(){a.onclick=e.onclick=r},this.openDialog=function(t,e){let n=app.Factory.createDialogJSON(t,e);s(!0),d(n)}}modePlay.Initialize(),app.AppView=joint.mvc.View.extend({el:".board",events:{"click .board__create-node":function(){this.addQuestion()},"click .board__start":"previewDialog","click #toolbar .code-snippet":"showCodeSnippet","click #toolbar .load-example":"loadExample","click #toolbar .clear":"clear"},init:function(){this.initializePaper()},initializePaper:function(){let t,e=this;joint.linkTools.mapping={Remove:joint.linkTools.Button.extend({children:[{tagName:"circle",selector:"button",attributes:{r:10,fill:"#f6f6f6",stroke:"#5755a1","stroke-width":2,cursor:"pointer"}},{tagName:"path",selector:"icon",attributes:{d:"M -4 -4 4 4 M -4 4 4 -4",fill:"none",stroke:"#5755a1","stroke-width":4,"pointer-events":"none"}}]})},joint.shapes.standard.Link.define("mapping.Link",{z:-1,attrs:{line:{targetMarker:{type:"path",fill:"#5755a1",d:"M 10 -5 0 0 10 5 z"},stroke:"gray"}}});let n=new joint.dia.Paper({el:this.$("#paper"),width:1500,height:500,gridSize:10,snapLinks:{radius:10},interactive:{vertexAdd:!1,arrowheadMove:!1,useLinkTools:!1},linkPinning:!1,multiLinks:!1,defaultLink:app.Factory.createLink(),defaultRouter:{name:"manhattan",args:{padding:10,maxAllowedDirectionChange:180,perpendicular:!1,startDirections:["right"],endDirections:["left"],maximumLoops:3e3}},defaultConnectionPoint:{name:"boundary",args:{sticky:!0}},defaultConnector:{name:"rounded",args:{radius:7}},validateConnection:function(t,e,n,i,o,a){return(!e||"in"!==e.getAttribute("port-group"))&&(t!==n&&(i&&"in"===i.getAttribute("port-group")||"qad.Question"===t.model.get("type")&&"qad.Answer"===n.model.get("type")))},validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")}});this.paper=n,n.off("cell:highlight"),n.on("cell:highlight",(function(t,e){e.parentNode.querySelector("#highlight").setAttribute("display","block")})),n.on("cell:unhighlight",(function(t,e){e.parentNode.querySelector("#highlight").setAttribute("display","none")}));var i=new joint.ui.PaperScroller({autoResizePaper:!0,padding:1e3,paper:n,cursor:"grab"});function o(t,e,n){i.zoom(.15*n,{min:.4,max:2.5,grid:.1,ox:t,oy:e})}function a(t){i.zoom(.4*t,{min:.4,max:2.5})}function r(t,n){commandManager.initBatchCommand(),t.remove(),e.updatePort(),commandManager.storeBatchCommand()}i.lock(),n.on("blank:pointerdown",i.startPanning),$("#app").append(i.render().el),n.on("link:mouseenter",(function(t){this.removeTools(),function(t){var e=new joint.dia.ToolsView({tools:[new joint.linkTools.mapping.Remove({distance:"92%",action:function(){r(this.model,t)}}),new joint.linkTools.mapping.Remove({distance:"8%",action:function(){r(this.model,t)}})]});t.addTools(e)}(t)})),n.on("blank:mousewheel",(function(t,e,n,i){t.preventDefault(),o(e,n,i)})),n.on("cell:mousewheel",(function(t,e,n,i,a){e.preventDefault(),o(n,i,a)})),n.on("cell:pointerclick",(function(e,n,i,o){n.preventDefault(),null!=t&&t.changeOutlineВotted(!1),t=e.model,e.model.changeOutlineВotted(!0)})),$(".zoom-in").on("click",(function(){a(1)})),$(".zoom-out").on("click",(function(){a(-1)})),n.on("link:mouseleave",(function(){this.removeTools()})),n.defs.innerHTML='<filter id="dropshadow"><feDropShadow dx="0" dy="8" stdDeviation="18" flood-color="#000000" flood-opacity="0.08"/></filter>',n.on("link:snap:connect",(function(t,e){e.stopPropagation(),this.updatePort()}),this),n.on("link:snap:disconnect",(function(t,e,n,i,o){e.stopPropagation(),null==t.targetView&&this.updatePort()}),this),this.graph=n.model,commandManager=new joint.dia.CommandManager({graph:this.graph}),$(".undo").click((function(){commandManager.undo()})),$(".redo").click((function(){commandManager.redo()})),n.on("element:delete",(function(t,e,n,i){e.stopPropagation();let o=0;t.model.remove(),_.each(this.graph.getCells(),(function(t){"qad.Question"==t.get("type")&&(o++,t.changeNumber(o))})),this.updatePort()}),this),n.on("element:edit",(function(e,n,i,o){n.stopPropagation(),null!=t&&t.changeOutlineВotted(!1),editNodeWindow.SetListItems(e.model,this)}),this),n.on("element:play",(function(t,e,n,i){e.stopPropagation(),modePlay.openDialog(this.graph,t.model.id)}),this),n.on("element:setStart",(function(t,e,n,i){e.stopPropagation();let o=this.findModelStart();o&&o.id==t.model.id||t.model.changeStartEnd(!0),o&&o.changeStartEnd(null)}),this),n.on("element:setEnd",(function(t,e,n,i){e.stopPropagation(),0!=t.model.get("startEnd")?t.model.changeStartEnd(!1):t.model.changeStartEnd(null)}),this),n.on("element:add",(function(t,e,n,i){e.stopPropagation();let o=t.model.get("position");this.addQuestion(o.x+530,o.y)}),this)},updatePort:function(){let t=this.paper,e={models:[],in:[],out:[]};_.each(this.graph.getCells(),(function(n){if("qad.Question"==n.get("type"))e.models.push(n);else{let i=t.findViewByModel(n);null!=i.targetMagnet&&(e.in.push(i.targetMagnet.getAttribute("port")),e.out.push(i.sourceMagnet.getAttribute("port")))}})),_.each(e.models,(function(t){let n=t.get("options"),i=t.get("question"),o=t.getPorts()[0].id;i.active=e.in.includes(o),_.each(n,(function(t){t.active=e.out.includes(t.id)})),t.applyOptionsAndQuestion(n,i),t.onChangeOptions(),t.onChangeQuestion()}))},addQuestion:function(t,e){let n=0,i=null==this.findModelStart();app.Factory.createQuestion("Question",i,t,e).addTo(this.graph),_.each(this.graph.getCells(),(function(t){"qad.Question"==t.get("type")&&(n++,t.changeNumber(n))}))},findModelStart:function(){let t=null;return _.each(this.graph.getCells(),function(e){if(e.get("startEnd"))return t=e,!1}.bind(this)),t},previewDialog:function(){modePlay.openDialog(this.graph)},clear:function(){this.graph.clear()},showCodeSnippet:function(){var t=this.selection.first(),e=app.Factory.createDialogJSON(this.graph,t),n=_.uniqueId("qad-dialog-"),i="";i+='<div id="'+n+'"></div>',i+='<link rel="stylesheet" type="text/css" href="http://qad.client.io/css/snippet.css"><\/script>',i+='<script type="text/javascript" src="http://qad.client.io/src/snippet.js"><\/script>',i+='<script type="text/javascript">',i+='document.getElementById("'+n+'").appendChild(qad.renderDialog('+JSON.stringify(e)+"))";var o="<textarea>"+(i+="<\/script>")+"</textarea>";new joint.ui.Dialog({width:"50%",height:200,draggable:!0,title:"Copy-paste this snippet to your HTML page.",content:o}).open()}}),joint.util.measureText=function(t){var e=V("svg").node,n=V("<text><tspan></tspan></text>").node,i=n.firstChild,o=document.createTextNode("");i.appendChild(o),e.appendChild(n),document.body.appendChild(e),o.data=t;var a=i.getBBox().width;if(a>220){let n=t.split(""),r="";for(let t=0;t<n.length;t++)if(r+=n[t],o.data=r,(a=i.getBBox().width)>=220)return V(e).remove(),r+"..."}return V(e).remove(),t};let editNodeWindow=new EditNodeWindow;function EditNodeWindow(){let t,e,n,i,o,a=0,r=document.querySelector(".node-edit"),s=document.querySelector(".node-edit__block"),d=s.querySelector(".node-edit__wrapper-item"),l=s.querySelector(".node-edit__header_btn"),c=s.querySelector(".node-edit__save"),h=s.querySelector(".node-edit__play"),u=new function(){let e;this.data={question:{text:""}},this.Initialize=function(t,n){this.data={question:JSON.parse(JSON.stringify(t.get("question"))),answers:JSON.parse(JSON.stringify(t.get("options"))),remove:[]},e=n},this.ApplyEdit=function(){t.applyEdit(this.data),e.updatePort()},this.addAnswer=function(t){let e={id:_.uniqueId("option-"),text:"",active:!1};return e.text=t||e.id,this.data.answers.push(e),e},this.removeAnswer=function(t){this.data.answers=_.without(this.data.answers,_.find(this.data.answers,{id:t})),this.data.remove.push(t)}};function p(){d.innerHTML="",i=null,n=0}function g(t){n++;let i=e.cloneNode(!0);d.appendChild(i),i.querySelector(".node-edit__remove-item").onclick=function(e){e.stopPropagation(),n--,this.parentNode.remove(),u.removeAnswer(t.id)},m(i,t)}function f(e){t.changeOutline(e),s.style.transform="translateX("+(e?0:764)+"px)",r.style.display=e?"block":"none"}function m(t,e){let n=t.querySelector(".node-edit__item"),o=n.querySelector(".node-edit__item_text"),r=n.querySelector(".node-edit__control_start"),s=n.querySelector(".node-edit__control_cancel"),d="";function l(t){n.style.height=(t||o.offsetHeight)+"px"}function c(t){o.value=u(t),d=e.text,e.text=t}function h(){t.classList.remove("excretionItem")}function u(t){let e,n,i=t.split(" ");!function(){let t=getComputedStyle(o);a=Math.max(a,o.offsetWidth-(parseInt(t.paddingLeft)+parseInt(t.paddingRight))),e=parseInt(t.lineHeight),n=document.createElement("p"),n.style.lineHeight=e+"px",n.style.fontSize=t.fontSize,n.style.fontFamily=t.fontFamily,n.style.display="inline-block",document.body.appendChild(n)}();let r=function(t){if(s(t)>1){let t="",e="";return function(){for(;;){let e=t+i[0]+" ";if(1==s(e))break;i.shift(),t=e}}(),function(){for(;e+=i.shift()+" ",2!=s(t+e););}(),function(){let t=e.split("");e="";for(let i=0;i<t.length;i++){let o=e+t[i];if(d(o)>=a-13){" "==t[i-1]&&(n(),"."==t[i-2]&&n()),"."==t[i-1]&&n();break}e=o}function n(){e=e.slice(0,-1)}}(),t+e+"..."}return t}(t);return n.remove(),r;function s(t){return l(t,!0),n.offsetHeight/e}function d(t){return l(t,!1),n.offsetWidth}function l(t,e){n.innerText=t,n.style.width=e?a+"px":"auto"}}autosize(o),o.addEventListener("autosize:resized",(function(){l()})),s.onclick=function(t){console.log("buttonCancel"),o.value=u(d),e.text=d},o.onfocus=function(n){null!=i&&h(),i=t,t.classList.add("excretionItem"),o.value=e.text,r.style.right="75px",s.style.right="5px",o.style.paddingBottom="35px",autosize.update(o),l(),console.log("onfocus")},o.onblur=function(t){h(),c(o.value),r.style.right="-75px",s.style.right="-145px",o.style.paddingBottom="10px",autosize.update(o),l(52),console.log("onblur")},c(e.text)}this.Initialize=function(){!function(){let t=d.querySelector(".node-edit__inner-item");e=t.cloneNode(!0),p()}(),function(){function t(t,e){let n=s.querySelector(t);console.log(n),n.onclick=function(){g(u.addAnswer(e))}}t(".node-edit__add-item"),t(".node-edit__add-next","Next")}(),o=document.querySelector(".node-edit__operator").querySelector(".node-edit__inner-item"),l.onclick=c.onclick=r.onclick=function(){u.ApplyEdit(),f(!1)},h.onclick=function(){console.log("play"),modePlay.openDialog(t.graph,t.id)}},this.SetListItems=function(e,n){u.Initialize(e,n),t=e,p(),function(){_.each(u.data.answers,function(t){g(t)}.bind(this))}(),f(!0),m(o,u.data.question)}}editNodeWindow.Initialize(),window.appView=new app.AppView,joint.setTheme("modern");