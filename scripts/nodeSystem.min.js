var commandManager,app=app||{},qad=window.qad||{};function InitQuestion(){joint.dia.Element.define("qad.Question",{ports:{groups:{in:{id:"in",position:{name:"left",args:{x:"-3",y:"62"}},attrs:{".back":{pointerEvents:"none",fill:"#ffd6d6",width:"24",height:"24",x:22,rx:4,ry:4},"#port-in":{magnet:"passive",fill:"transparent",width:"50",height:"24"},"#highlight":{display:"none",pointerEvents:"none",fill:"#FEB663",width:"30",height:"30",y:-3,x:19,rx:7,ry:7},image:{pointerEvents:"none"}},markup:'<rect id="port-in"/>',label:{markup:'<rect id="highlight" /><rect class="back"/><image width="14" height="10" style="transform: matrix(-1,0,0,1,42,7)" xlink:href="img/board/Union.svg"/>'}},out:{position:{args:{x:330}},attrs:{".back":{pointerEvents:"all",magnet:!0,fill:"#ffd6d6",width:"24",height:"24",rx:4,ry:4},"#connector":{pointerEvents:"none",fill:"transparent",width:"75",height:"24"},image:{pointerEvents:"none"}},label:{position:{args:{x:5,y:3}},markup:'<image width="14" height="10" xlink:href="img/board/Union.svg"/>'},markup:'<rect class="back"/><rect id="connector"/>'}},items:[{group:"in"}]},attrs:{".":{magnet:!1},"#header-strat":{display:"block"},"#header-strat #startBorder":{width:38,height:20,rx:"6",ry:"6",x:32,y:7,fill:"transparent",strokeWidth:1,stroke:"#1CCF64"},"#header-strat #start":{fill:"#1CCF64",fontFamily:"Nunito-Black",x:36,y:21,fontSize:12},"#header-end":{display:"none"},"#header-end #endBorder":{width:38,height:20,rx:"6",ry:"6",x:32,y:7,fill:"transparent",strokeWidth:1,stroke:"black"},"#header-end #end":{fill:"black",fontFamily:"Nunito-Black",x:40,y:21,fontSize:12},"#header-control #back":{width:81,height:117,fill:"transparent",x:400,y:0},"#header-control #startNode":{event:"element:setStart",transform:"translate(420, 0)",cursor:"pointer"},"#header-control #startNode text":{fill:"black",fontFamily:"Nunito-Black",x:6.5,y:24,fontSize:19},"#header-control #startNode rect":{width:61,height:35,rx:"6",ry:"6",y:0,fill:"transparent",strokeWidth:1,stroke:"black"},"#header-control #endNode":{event:"element:setEnd",transform:"translate(420, 40)",cursor:"pointer"},"#header-control #endNode text":{fill:"black",fontFamily:"Nunito-Black",x:13,y:24,fontSize:19},"#header-control #endNode rect":{width:61,height:35,rx:"6",ry:"6",fill:"transparent",strokeWidth:1,stroke:"black"},"#header-control #add":{event:"element:add",transform:"translate(420, 81)",cursor:"pointer"},"#header-control #add rect":{width:61,height:35,fill:"transparent",strokeWidth:1,stroke:"black",rx:"6",ry:"6"},"#header-control #add text":{fill:"black",fontFamily:"Nunito-Black",x:7,y:24,fontSize:19},"#header #number":{display:"none",fill:"#998A8A",fontFamily:"Nunito-Bold",x:10,y:48,fontSize:12},"#main-back":{fill:"#fff",refWidth:"100%",refHeight:"100%",filter:"url(#dropshadow)",rx:"7",ry:"7"},"#header #play":{event:"element:play",refX:"50%",refX2:"-8",y:7,width:16,height:19,cursor:"pointer"},"#header #remove":{event:"element:delete",refDx:-17,y:7,width:10,height:9,cursor:"pointer"},"#header #untitle":{x:32,y:53,fill:"#999999",fontFamily:"Nunito-Regular",fontSize:18,lineHeight:"24",letterSpacing:"-0.3"},"#header #question-title":{x:32,y:80,fontFamily:"Nunito-SemiBold",fontSize:18,lineHeight:24},"#header #border-bottom":{fill:"#F0E6E6",y:107,refWidth:1,height:2},"#body #title":{x:32,y:150,fill:"#999999",fontSize:18,lineHeight:24},"#footer #edit rect":{event:"element:edit",fill:"#1d85d0",refX:"50%",refX2:"-42%",refDy:"-80",rx:"6",ry:"6",refWidth:"84%",height:48,cursor:"pointer"},"#footer #edit text":{refX:"50%",refDy:"-50",fill:"#fff",textAnchor:"middle",fontFamily:"Nunito-Bold",fontSize:18,pointerEvents:"none"},text:{fontFamily:"Nunito-Regular",letterSpacing:"-0.3"},".option .subtitle":{fill:"#999999",fontSize:12,x:44,yAlignment:"middle",fontFamily:"Nunito-Bold"},".option .title":{fontSize:14,x:44,yAlignment:"middle",fontFamily:"Nunito-Bold"},".option .back":{refX:"50%",refX2:"-42%",refWidth:"84%",height:52,rx:"6",ry:"6",fill:"#fff",strokeWidth:1,stroke:"#F0E6E6"},".option .add":{transform:"translate(303, 14)"},".option .add rect":{event:"element:addFromOut",cursor:"pointer",fill:"#BED2A6",width:"24",height:"24",rx:4,ry:4},".option .add image":{x:6,y:6,pointerEvents:"none"},"#outline":{display:"none",fill:"transparent",strokeWidth:3,stroke:"#1d85d0",refWidth:"100%",refHeight:"100%",refWidth2:"20",refHeight2:"20",refX:"-10",refY:"-10",rx:"6",ry:"6",pointerEvents:"none"},"#outlineВotted":{display:"none"},"#outlineВotted #botted":{fill:"transparent",strokeWidth:3,stroke:"#1d85d0",strokeDasharray:"5",refWidth:"100%",refHeight:"100%",refWidth2:"20",refHeight2:"20",refX:"-10",refY:"-10",rx:"6",ry:"6",pointerEvents:"none"}}},{markup:['<g id="outlineВotted">','<rect id="botted"/>','<g id="header-control">','<rect id="back" />','<g id="startNode">',"<rect/>","<text>Start</text>","</g>",'<g id="endNode">',"<rect/>","<text>End</text>","</g>",'<g id="add">',"<rect/>","<text>Node</text>","</g>","</g>","</g>",'<rect id="main-back"/>','<g id="header">','<g id="header-strat">','<rect id="startBorder" />','<text id="start">Start</text>',"</g>",'<g id="header-end">','<rect id="endBorder" />','<text id="end">End</text>',"</g>",'<text id="number">Node №1</text>','<image id="play" xlink:href="img/board/Play.svg"/>','<image id="remove" xlink:href="img/board/cross.svg"/>','<text id="untitle"> Operator phrase: </text>','<text id="question-title"/>','<rect id="border-bottom"/>',"</g>",'<g id="body">','<text id="title">Response:</text>',"</g>",'<g id="footer">','<g id="edit">',"<rect/>","<text>Click to edit</text>","</g>","</g>",'<g class="options"></g>','<rect id="outline" />'].join(""),optionMarkup:['<g class="option">','<rect class="back"/>','<text class="subtitle"/>','<text class="title"/>','<g class="add">',"<rect/>",'<image width="12" height="12" xlink:href="img/board/arrowAdd.svg"/>',"</g>","</g>"].join(""),initialize:function(){joint.dia.Element.prototype.initialize.apply(this,arguments),this.on("change:options",this.onChangeOptions,this),this.on("change:question",this.onChangeQuestion,this),this.on("change:outline",this.onChangeOutline,this),this.on("change:outlineВotted",this.onChangeOutlineВotted,this),this.on("change:number",this.onChangeNumber,this),this.on("change:startEnd",this.onChangeStartEnd,this),this.on("change:questionHeight",(function(){this.attr(".options/refY",170,{silent:!0})}),this),this.attr(".options/refY",170,{silent:!0}),this.attr("#question-title/text",joint.util.measureText(this.get("question").text),{silent:!0}),this.onChangeOptions()},onChangeQuestion:function(){let t=this.get("question"),e=t.active?"#FFF0BC":"#ffd6d6",n=this.getPorts()[0];null!=n&&"in"==n.group&&(null!=n.attrs&&n.attrs[".back"].fill==e||this.portProp(n.id,"attrs/.back/fill",e));let i=joint.util.measureText(t.text);i!=this.attr("#question-title/text")&&this.attr("#question-title/text",i)},onChangeOptions:function(){var t=this.get("options"),e=0,n={};_.each(t,function(t,i){var o=".option-"+t.id;n[o]={transform:"translate(0, "+e+")",dynamic:!0},n[o+" .back"]={height:50,dynamic:!0},n[o+" .subtitle"]={text:"Option "+(i+1),dynamic:!0,refY:15},n[o+" .title"]={text:joint.util.measureText(t.text),dynamic:!0,refY:33},e+=50;var r=(e+=14)-50+170;this.getPort(t.id)?(this.portProp(t.id,"args/y",r),this.portProp(t.id,"attrs/.back/fill",t.active?"#FFF0BC":"#ffd6d6"),this.portProp(t.id,"attrs/.back/pointerEvents",t.active?"none":"all")):this.addPort({group:"out",id:t.id,args:{y:r}})}.bind(this)),this.attr(n),this.autoresize()},onChangeOutline:function(){let t=this.get("outline");this.attr("#outline/display",t?"block":"none")},"onChangeOutlineВotted":function(){let t=this.get("outlineВotted");this.attr("#outlineВotted/display",t?"block":"none")},onChangeNumber:function(){let t=this.get("number");this.attr("#number/text","Node №"+t)},onChangeStartEnd:function(){let t=this,e=this.get("startEnd");function n(e,n){t.attr("#header-strat/display",e),t.attr("#header-end/display",n)}null==e?n("none","none"):n(e?"block":"none",e?"none":"block")},autoresize:function(){var t=this.get("options")||[],e=50*t.length+14*(t.length-1)+170+100;this.resize(400,e)},applyEdit:function(t){commandManager.initBatchCommand(),_.each(t.remove,function(t){this.removePort(t)}.bind(this)),this.set("options",t.answers),this.set("question",t.question),this.set("comments",t.comments),commandManager.storeBatchCommand()},addOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));e.push(t),this.set("options",e),commandManager.storeBatchCommand()},removeOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));this.removePort(t),this.set("options",_.without(e,_.find(e,{id:t}))),commandManager.storeBatchCommand()},changeOptionActivity:function(t,e){commandManager.initBatchCommand();var n=JSON.parse(JSON.stringify(this.get("options")));n[_.findIndex(n,{id:t})].active=e,this.set("options",n),commandManager.storeBatchCommand()},changeQuestionActivity:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("question")));e.active=t,this.set("question",e),commandManager.storeBatchCommand()},changeOutline:function(t){var e=JSON.parse(JSON.stringify(this.get("outline")));e=t,this.set("outline",e)},"changeOutlineВotted":function(t){var e=JSON.parse(JSON.stringify(this.get("outlineВotted")));e=t,this.set("outlineВotted",e)},changeNumber:function(t){var e=JSON.parse(JSON.stringify(this.get("number")));e=t,this.set("number",e)},changeStartEnd:function(t){this.set("startEnd",t)},applyOptionsAndQuestion:function(t,e){this.set("options",t),this.set("question",e)}})}InitQuestion(),joint.shapes.qad.QuestionView=joint.dia.ElementView.extend({events:{"click #add-answer image":"onAddOption","click .btn-remove-option":"onRemoveOption"},presentationAttributes:joint.dia.ElementView.addPresentationAttributes({options:["OPTIONS"]}),confirmUpdate:function(t){joint.dia.ElementView.prototype.confirmUpdate.apply(this,arguments),this.hasFlag(t,"OPTIONS")&&this.renderOptions()},renderMarkup:function(){joint.dia.ElementView.prototype.renderMarkup.apply(this,arguments),this.$options=this.$(".options"),this.elOption=V(this.model.optionMarkup),this.renderOptions()},renderOptions:function(){this.$options.empty(),_.each(this.model.get("options"),function(t,e){var n="option-"+t.id,i=this.elOption.clone().addClass(n);i.attr("option-id",t.id),this.$options.append(i.node)}.bind(this)),this.update()},onAddOption:function(){this.model.addOption({id:_.uniqueId("option-"),text:"Answer "+(this.model.get("options").length+1),active:!1})},onRemoveOption:function(t){this.model.removeOption(V(t.target.parentNode).attr("option-id"))}}),app.Selection=Backbone.Collection.extend(),app.SelectionView=joint.mvc.View.extend({PADDING:3,BOX_TEMPLATE:V("rect",{stroke:"#C6C7E2","stroke-width":1,"pointer-events":"none"}),init:function(){this.listenTo(this.model,"add reset change",this.render)},render:function(){return _.invokeMap(this.boxes,"remove"),this.boxes=this.model.map(function(t){return this.BOX_TEMPLATE.clone().attr(t.getBBox().inflate(this.PADDING)).appendTo(this.options.paper.cells)}.bind(this)),this},onRemove:function(){_.invokeMap(this.boxes,"remove"),delete this.boxes}}),app.Factory={createQuestion:function(t,e,n,i){return new joint.shapes.qad.Question({attrs:{"#header-strat":{display:e?"block":"none"}},position:{x:n||400,y:i||250},question:{text:t,active:!1},startEnd:!!e||null,outline:!1,"outlineВotted":!1,number:1,options:[],comments:null})},createLink:function(){return new joint.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"#6a6c8a",stroke:"#6a6c8a"},".connection":{stroke:"#6a6c8a",strokeWidth:2},".marker-arrowheads":{display:"none"},".tool-remove":{display:"none"}}})},createDialogJSON:function(t,e){var n={startNode:void 0,nodes:[],links:[]};return _.each(t.getCells(),(function(t){var i={id:t.id,type:t.get("type")};switch(t.get("type")){case"qad.Question":i.question=t.get("question"),i.options=t.get("options"),n.nodes.push(i),e?e==t.id&&(n.startNode=n.nodes.length-1):t.get("startEnd")&&(n.startNode=n.nodes.length-1);break;default:i.source=t.get("source"),i.target=t.get("target"),n.links.push(i)}})),n}};let modePlay=new ModePlay;function ModePlay(){let t,e,n=this,i=document.querySelector(".mode-start"),o=document.querySelector(".mode-start__block"),r=o.querySelector(".mode-start__answer"),a=o.querySelector(".mode-start__questions_text"),s=o.querySelector(".mode-start__header_close"),l=o.querySelector(".mode-start__header_open-edit");function d(){c(!1)}function c(t){i.style.display=t?"block":"none",o.style.display=t?"block":"none"}function u(t,e){n.dataNodes=t,e||(e=t.nodes[t.startNode]),function(t){r.innerHTML="";for(var e=0;e<t.options.length;e++)r.appendChild(h(t.options[e]));a.innerHTML=t.question.text}(e),n.currentNode=e}function h(t){var e,i,o,r=(e="div",i="mode-start__answer_item",(o=document.createElement(e)).setAttribute("class",i),o);r.innerHTML=t.text;let a=t.id;return r.textContent.length>40&&(r.style.width="100%"),r.onclick=function(){!function(t){for(var e,i=0;i<n.dataNodes.links.length;i++){var o=n.dataNodes.links[i];if(o.source.id===n.currentNode.id&&o.source.port===t){e=o;break}}if(e){for(var r,a=0;a<n.dataNodes.nodes.length;a++){var s=n.dataNodes.nodes[a];if(s.id===e.target.id){r=s;break}}r&&u(n.dataNodes,r)}}(a)},r}this.Initialize=function(){s.onclick=i.onclick=d,l.onclick=function(){d(),editNodeWindow.SetListItems(t,e)}},this.openDialog=function(n,i){t=n,e=i;let o=app.Factory.createDialogJSON(e.graph,n.id);c(!0),u(o)}}modePlay.Initialize(),app.AppView=joint.mvc.View.extend({el:".board",events:{"click .board__create-node":function(){this.addQuestion()},"click .board__start":"previewDialog","click #toolbar .code-snippet":"showCodeSnippet","click #toolbar .load-example":"loadExample","click #toolbar .clear":"clear"},init:function(){this.initializePaper()},initializePaper:function(){let t,e=this;joint.linkTools.mapping={Remove:joint.linkTools.Button.extend({children:[{tagName:"circle",selector:"button",attributes:{r:10,fill:"#f6f6f6",stroke:"#5755a1","stroke-width":2,cursor:"pointer"}},{tagName:"path",selector:"icon",attributes:{d:"M -4 -4 4 4 M -4 4 4 -4",fill:"none",stroke:"#5755a1","stroke-width":4,"pointer-events":"none"}}]})},joint.shapes.standard.Link.define("mapping.Link",{z:-1,attrs:{line:{targetMarker:{type:"path",fill:"#5755a1",d:"M 10 -5 0 0 10 5 z"},stroke:"gray"}}});let n=new joint.dia.Paper({el:this.$("#paper"),width:1500,height:500,gridSize:10,snapLinks:{radius:10},interactive:{vertexAdd:!1,arrowheadMove:!1,useLinkTools:!1},linkPinning:!1,multiLinks:!1,defaultLink:app.Factory.createLink(),defaultRouter:{name:"manhattan",args:{padding:10,maxAllowedDirectionChange:180,perpendicular:!1,startDirections:["right"],endDirections:["left"],maximumLoops:3e3}},defaultConnectionPoint:{name:"boundary",args:{sticky:!0}},defaultConnector:{name:"rounded",args:{radius:7}},validateConnection:function(t,e,n,i,o,r){return(!e||"in"!==e.getAttribute("port-group"))&&(t!==n&&(i&&"in"===i.getAttribute("port-group")||"qad.Question"===t.model.get("type")&&"qad.Answer"===n.model.get("type")))},validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")}});this.paper=n,n.off("cell:highlight"),n.on("cell:highlight",(function(t,e){e.parentNode.querySelector("#highlight").setAttribute("display","block")})),n.on("cell:unhighlight",(function(t,e){e.parentNode.querySelector("#highlight").setAttribute("display","none")}));var i=new joint.ui.PaperScroller({autoResizePaper:!0,padding:1e3,paper:n,cursor:"grab"});function o(t,e,n){i.zoom(.15*n,{min:.4,max:2.5,grid:.1,ox:t,oy:e})}function r(t){i.zoom(.4*t,{min:.4,max:2.5})}function a(t,n){commandManager.initBatchCommand(),t.remove(),e.updatePort(),commandManager.storeBatchCommand()}i.lock(),n.on("blank:pointerdown",i.startPanning),$("#app").append(i.render().el),n.on("link:mouseenter",(function(t){this.removeTools(),function(t){var e=new joint.dia.ToolsView({tools:[new joint.linkTools.mapping.Remove({distance:"92%",action:function(){a(this.model,t)}}),new joint.linkTools.mapping.Remove({distance:"8%",action:function(){a(this.model,t)}})]});t.addTools(e)}(t)})),n.on("blank:mousewheel",(function(t,e,n,i){t.preventDefault(),o(e,n,i)})),n.on("cell:mousewheel",(function(t,e,n,i,r){e.preventDefault(),o(n,i,r)})),n.on("cell:pointerclick",(function(e,n,i,o){n.preventDefault(),null!=t&&t.changeOutlineВotted(!1),t=e.model,e.model.changeOutlineВotted(!0)})),$(".zoom-in").on("click",(function(){r(1)})),$(".zoom-out").on("click",(function(){r(-1)})),n.on("link:mouseleave",(function(){this.removeTools()})),n.defs.innerHTML='<filter id="dropshadow"><feDropShadow dx="0" dy="8" stdDeviation="18" flood-color="#000000" flood-opacity="0.08"/></filter>',n.on("link:snap:connect",(function(t,e){e.stopPropagation(),this.updatePort()}),this),n.on("link:snap:disconnect",(function(t,e,n,i,o){e.stopPropagation(),null==t.targetView&&this.updatePort()}),this),this.graph=n.model,commandManager=new joint.dia.CommandManager({graph:this.graph}),$(".undo").click((function(){commandManager.undo()})),$(".redo").click((function(){commandManager.redo()})),n.on("element:delete",(function(t,e,n,i){e.stopPropagation();let o=0;t.model.remove(),_.each(this.graph.getCells(),(function(t){"qad.Question"==t.get("type")&&(o++,t.changeNumber(o))})),this.updatePort()}),this),n.on("element:edit",(function(e,n,i,o){n.stopPropagation(),null!=t&&t.changeOutlineВotted(!1),editNodeWindow.SetListItems(e.model,this)}),this),n.on("element:addFromOut",(function(t,e,n,i){e.stopPropagation();let o=app.Factory.createLink(),r=t.model.get("position"),a=this.addQuestion(r.x+530,r.y);o.addTo(this.graph),o.source({id:t.model.get("id"),port:e.target.parentNode.parentNode.getAttribute("option-id")}),o.target({id:a.get("id"),port:a.getPorts()[0].id}),this.updatePort()}),this),n.on("element:play",(function(t,e,n,i){e.stopPropagation(),modePlay.openDialog(t.model,this)}),this),n.on("element:setStart",(function(t,e,n,i){e.stopPropagation();let o=this.findModelStart();o&&o.id==t.model.id||t.model.changeStartEnd(!0),o&&o.changeStartEnd(null)}),this),n.on("element:setEnd",(function(t,e,n,i){e.stopPropagation(),0!=t.model.get("startEnd")?t.model.changeStartEnd(!1):t.model.changeStartEnd(null)}),this),n.on("element:add",(function(t,e,n,i){e.stopPropagation();let o=t.model.get("position");this.addQuestion(o.x+530,o.y)}),this)},updatePort:function(){let t=this.paper,e={models:[],in:[],out:[]};_.each(this.graph.getCells(),(function(n){if("qad.Question"==n.get("type"))e.models.push(n);else{let i=t.findViewByModel(n);null!=i.targetMagnet&&(e.in.push(i.targetMagnet.getAttribute("port")),e.out.push(i.sourceMagnet.getAttribute("port")))}})),_.each(e.models,(function(t){let n=t.get("options"),i=t.get("question"),o=t.getPorts()[0].id;i.active=e.in.includes(o),_.each(n,(function(t){t.active=e.out.includes(t.id)})),t.applyOptionsAndQuestion(n,i),t.onChangeOptions(),t.onChangeQuestion()}))},addQuestion:function(t,e){let n=0,i=null==this.findModelStart(),o=app.Factory.createQuestion("<p>Empty</p>",i,t,e);return o.addTo(this.graph),_.each(this.graph.getCells(),(function(t){"qad.Question"==t.get("type")&&(n++,t.changeNumber(n))})),o},findModelStart:function(){let t=null;return _.each(this.graph.getCells(),function(e){if(e.get("startEnd"))return t=e,!1}.bind(this)),t},previewDialog:function(){modePlay.openDialog(null,this)},clear:function(){this.graph.clear()},showCodeSnippet:function(){var t=this.selection.first(),e=app.Factory.createDialogJSON(this.graph,t),n=_.uniqueId("qad-dialog-"),i="";i+='<div id="'+n+'"></div>',i+='<link rel="stylesheet" type="text/css" href="http://qad.client.io/css/snippet.css"><\/script>',i+='<script type="text/javascript" src="http://qad.client.io/src/snippet.js"><\/script>',i+='<script type="text/javascript">',i+='document.getElementById("'+n+'").appendChild(qad.renderDialog('+JSON.stringify(e)+"))";var o="<textarea>"+(i+="<\/script>")+"</textarea>";new joint.ui.Dialog({width:"50%",height:200,draggable:!0,title:"Copy-paste this snippet to your HTML page.",content:o}).open()}}),joint.util.measureText=function(t){let e=[...t.matchAll(/<(?:p|li)>(.*?)<\/(?:p|li)>/g)];t=e[0][1].replace(/<.*?>/g,"");var n=V("svg").node,i=V("<text><tspan></tspan></text>").node,o=i.firstChild,r=document.createTextNode("");o.appendChild(r),n.appendChild(i),document.body.appendChild(n),r.data=t;var a=o.getBBox().width;let s=t;if(a>200){let e=t.split("");s="";for(let t=0;t<e.length;t++)if(s+=e[t],r.data=s,(a=o.getBBox().width)>=200){s+="...";break}}else e.length>1&&(s+="...");return V(n).remove(),s};let editNodeWindow=new EditNodeWindow;function EditNodeWindow(){let t,e,n,i,o,r=0,a=document.querySelector(".node-edit"),s=document.querySelector(".node-edit__block"),l=s.querySelector(".node-edit__wrapper-item"),d=s.querySelector(".node-edit__header_btn"),c=s.querySelector(".node-edit__save"),u=s.querySelector(".node-edit__play"),h=new function(){this.data={question:{text:""}},this.Initialize=function(){this.data={question:JSON.parse(JSON.stringify(t.get("question"))),answers:JSON.parse(JSON.stringify(t.get("options"))),comments:"",remove:[]}},this.ApplyEdit=function(){this.data.comments=p.GetTextHTML(),t.applyEdit(this.data),o.updatePort()},this.addAnswer=function(t){let e={id:_.uniqueId("option-"),text:"",active:!1};return e.text="<p>"+(t||e.id)+"</p>",this.data.answers.push(e),e},this.removeAnswer=function(t){this.data.answers=_.without(this.data.answers,_.find(this.data.answers,{id:t})),this.data.remove.push(t)}},p=new function(){let e,n=['<div class="comment__item">','<div class="comment__item_img"></div>','<div class="comment__item_inner">','<div class="comment__item_info">','<p class="comment__item_name">Jane Cooper</p>','<p class="comment__item_time">15 feb at 14:30</p>',"</div>",'<div class="comment__wrap-text">',"</div>","</div>","</div>"].join(""),i=['<div class="comment__item_text">','<input type="text" class="comment__text-edit" autocomplete="off">','<p class="comment__user_text">Hey Marvin, please chang the call guidance instructions according to the new rules.</p>','<span class="comment__item_edit"></span>','<span class="comment__item_del"></span>',"</div>"].join(""),o=document.querySelector(".comment"),r=o.querySelector(".comment__text"),a=o.querySelector(".comment__add-comment"),l=s.querySelector(".comment__wrap-item");function d(){let t=l.lastChild.querySelector(".comment__wrap-text");t.appendChild(document.createRange().createContextualFragment(i));let e=t.lastChild;e.querySelector(".comment__user_text").innerHTML=r.value,c(e),function(){let t=document.querySelectorAll(".comment__item_del");for(let n=0;n<t.length;n++){let i=t[n].closest(".comment__item_text");function e(){i.remove()}t[n].addEventListener("click",e)}}(),r.value="",r.style.height="52px",r.focus(),s.scrollTop=s.scrollHeight}function c(t){let n=t.querySelector(".comment__user_text"),i=t.querySelector(".comment__text-edit"),o=t.querySelector(".comment__item_edit"),r=!1;console.log(o),o.onclick=function(){function t(t){i.style.display=t}e==o?e=null:null!=e?(e.onclick(),e=o):null==e&&(e=o),r=!r,o.classList.toggle("switcherIconApply"),r?(t("block"),i.value=n.innerText,i.focus()):(t("none"),n.innerText=i.value)}}this.Initialize=function(){!function(){function t(t){r.parentNode.contains(t.target)||e("-120px","0")}function e(e,n){a.style.right=e,r.style.marginBottom=n,document.removeEventListener("click",t)}r.onclick=function(){e("30px","54px"),document.addEventListener("click",t)}}(),a.onclick=function(){r.value.length<1?r.focus():(1==l.children.length&&function(){l.appendChild(document.createRange().createContextualFragment(n));let t=l.lastChild;t.querySelector(".comment__item_img").style.background="url(img/board/Ellipse-2.png) center/cover no-repeat",t.querySelector(".comment__item_name").innerHTML="Marvin Cooper"}(),d())}},this.UpdateEvents=function(){!function(){let e=t.get("comments");if(!e)return l.innerHTML=n,void(l.querySelector(".comment__wrap-text").innerHTML=i);l.innerHTML=e}(),function(){let t=l.querySelectorAll(".comment__item_text");for(let e=0;e<t.length;e++)c(t[e])}()},this.GetTextHTML=function(){return l.innerHTML}};function m(){l.innerHTML="",n=null,countItems=0}function f(t){countItems++;let n=e.cloneNode(!0);l.appendChild(n),n.querySelector(".node-edit__remove-item").onclick=function(e){e.stopPropagation(),countItems--,this.parentNode.remove(),h.removeAnswer(t.id)},y(n,t)}function g(e){t.changeOutline(e),s.style.transform="translateX("+(e?0:764)+"px)",a.style.display=e?"block":"none"}function y(t,e){let i=t.querySelector(".node-edit__item"),o=i.querySelector("#editor"),a=Quill.find(o)||new Quill(o,{theme:"snow"}),s=i.querySelector(".ql-editor"),l=i.querySelector(".node-edit__control_start"),d=i.querySelector(".node-edit__control_cancel"),c=i.querySelector(".ql-toolbar"),u="";function h(t,e,n){s.style.paddingBottom=e+"px",s.style.paddingTop=n+"px",t||(t=e+n,_.each(s.children,function(e){t+=e.offsetHeight}.bind(this))),i.style.height=t+"px"}function p(t){s.innerHTML=f(t),u=e.text,e.text=t}function m(){t.classList.remove("excretionItem")}function f(t){let e,n,i=[...t.matchAll(/<(?:p|li)>(.*?)<\/(?:p|li)>/g)];t=i[0][1].replace(/<.*?>/g,""),function(){let t=getComputedStyle(s);r=Math.max(r,s.offsetWidth-(parseInt(t.paddingLeft)+parseInt(t.paddingRight))),e=parseInt(t.lineHeight),n=document.createElement("p"),n.style.lineHeight=e+"px",n.style.fontSize=t.fontSize,n.style.fontFamily=t.fontFamily,n.style.display="inline-block",document.body.appendChild(n)}();let o=function(){let e=t.split(" ");if(a(t)>1){let t="",n="";return function(){for(;;){let n=t+e[0]+" ";if(1==a(n))break;e.shift(),t=n}}(),function(){for(;n+=e.shift()+" ",2!=a(t+n););}(),function(){let t=n.split("");n="";for(let i=0;i<t.length;i++){let o=n+t[i];if(l(o)>=r-13){" "==t[i-1]&&(e(),"."==t[i-2]&&e()),"."==t[i-1]&&e();break}n=o}function e(){n=n.slice(0,-1)}}(),t+n+"..."}return t+(i.length>1?"...":"")}();return n.remove(),o;function a(t){return d(t,!0),n.offsetHeight/e}function l(t){return d(t,!1),n.offsetWidth}function d(t,e){n.innerText=t,n.style.width=e?r+"px":"auto"}}autosize(s),function(){function o(i){s.onfocus=null,document.addEventListener("mousedown",g),c.style.top=0,function(){null!=n&&m();n=t,t.classList.add("excretionItem"),s.value=e.text}(),l.style.right="75px",d.style.right="5px",r(),s.innerHTML=e.text,a.on("text-change",r)}function r(){h(null,35,50)}function g(t){i.contains(t.target)||y()}function y(){a.off("text-change",r),s.onfocus=o,document.removeEventListener("mousedown",g),c.style.top="-48px",m(),p(s.innerHTML),l.style.right="-75px",d.style.right="-145px",h(52,10,24)}d.onclick=function(t){y(),s.innerHTML=f(u),e.text=u},l.onclick=function(t){y()},s.onfocus=o}(),p(e.text)}this.Initialize=function(){!function(){let t=l.querySelector(".node-edit__inner-item");e=t.cloneNode(!0),m()}(),function(){function t(t,e){s.querySelector(t).onclick=function(){f(h.addAnswer(e))}}t(".node-edit__add-item"),t(".node-edit__add-next","Next")}(),i=document.querySelector(".node-edit__operator").querySelector(".node-edit__inner-item"),d.onclick=a.onclick=function(){h.ApplyEdit(),g(!1)},c.onclick=function(){h.ApplyEdit()},u.onclick=function(){h.ApplyEdit(),modePlay.openDialog(t,o)},p.Initialize()},this.SetListItems=function(e,n){t=e,o=n,h.Initialize(),p.UpdateEvents(),m(),function(){_.each(h.data.answers,function(t){f(t)}.bind(this))}(),g(!0),y(i,h.data.question),function(){let t=document.querySelectorAll("#editor");if(1==t.length){let e=Quill.find(t[0]);setTimeout(()=>{e.focus(),setTimeout(()=>{e.setSelection(e.getLength(),0)},0)},0)}}()}}function ControlCommentHistory(){let t=document.querySelector(".board__comment"),e=document.querySelector(".comment-history"),n=document.querySelector(".comment-history__block");function i(t,i){e.style.display=t,n.style.transform=i}t.addEventListener("click",(function(){i("block","translateX(0)")})),e.addEventListener("click",(function(){i("none","translateX(764px)")}))}editNodeWindow.Initialize(),ControlCommentHistory(),window.appView=new app.AppView,joint.setTheme("modern");