var commandManager,app=app||{},qad=window.qad||{};function InitQuestion(){joint.dia.Element.define("qad.Question",{ports:{groups:{in:{id:"in",position:{name:"left",args:{y:"60"}},attrs:{circle:{magnet:"passive",stroke:"#b6b6b6",strokeWidth:2,fill:"#ffd6d6",r:10},text:{pointerEvents:"none",fontSize:12},itemHighlight:{fill:"#fff"}},markup:'<circle id="port-in"/>',label:{markup:'<image width="13" height="8" style="transform: matrix(-1,0,0,1,6,-8)" xlink:href="img/board/fork.svg"></image>'}},out:{position:{args:{x:235}},attrs:{circle:{magnet:!0,stroke:"#b6b6b6",fill:"#ffd6d6",strokeWidth:2,r:10},image:{pointerEvents:"none"}},label:{position:{args:{x:-6,y:-8}},markup:'<image width="12" height="8" xlink:href="img/board/fork.svg"></image>'},markup:"<circle/>"}}},attrs:{".":{magnet:!1},"#main-back":{fill:"#e2f7dc",refWidth:"100%",refHeight:"100%",filter:"url(#dropshadow)",rx:"5",ry:"5"},"#header #play":{event:"element:play",x:113,y:2,width:16,height:19,cursor:"pointer"},"#header #remove":{event:"element:delete",x:216,y:8,width:10,height:9,cursor:"pointer"},"#header text":{x:7,y:16},"#header-logo":{display:"block"},"#header-logo rect":{fill:"#f2f2f2",refX:"50%",refX2:"-50",y:"-25",width:100,height:"50",rx:"5",ry:"5",strokeWidth:2,stroke:"black"},"#header-logo text":{x:86,y:-7,fontSize:14,fontWeight:600},"#body rect":{fill:"#e4f3ff",y:23,refWidth:"-6",x:3,height:71},"#body #edit":{event:"element:edit",x:9,y:32,width:13,height:13,cursor:"pointer"},"#body #title-question":{x:25,y:53,fontSize:14,fontWeight:600},"#body #question-text":{x:25,y:73,fontSize:14},"#footer #title-footer":{x:25,y:116,fontSize:14,fontWeight:600},"#footer rect":{fill:"#B6B6B6",x:3,y:128,refWidth:"-6",refHeight:-163,z:-1},"#add-answer text":{refX:31,refDy:-14,fontSize:12},"#add-answer image":{refX:"50%",refX2:"-13.5",refDy:-31,height:26,width:26,cursor:"pointer"},".btn-remove-option":{height:20,width:20,x:3,y:5,cursor:"pointer"},".options":{refX:0},text:{fontFamily:"Roboto-Regular"},".option-text":{fontSize:13,fill:"#4b4a67",refX:30,yAlignment:"middle"},".option-rect":{fill:"#e2f7dc",width:235}}},{markup:['<g id="header-logo">',"<rect/>","<text>Start node</text>","</g>",'<rect id="main-back" />','<g id="header">','<text font-size="14">node #1</text>','<image id="play" xlink:href="img/board/Play.svg"/>','<image id="remove" xlink:href="img/board/cross.svg"/>',"</g>",'<g id="body">',"<rect/>",'<image id="edit" xlink:href="img/board/pen.svg"/>','<text id="title-question"> Operator phrase: </text>','<text id="question-text"/>',"</g>",'<g id="footer">',"<rect/>",'<text id="title-footer">Response:</text>','<g id="add-answer">',"<text>Add answer</text>",'<image xlink:href="img/board/add-answer.svg"/>',"</g>","</g>",'<g class="options"></g>'].join(""),optionMarkup:['<g class="option">','<rect class="option-rect" />','<image class="btn-remove-option" xlink:href="img/board/btn-remove.svg"/>','<text class="option-text"/>',"</g>"].join(""),initialize:function(){joint.dia.Element.prototype.initialize.apply(this,arguments),this.on("change:options",this.onChangeOptions,this),this.on("change:question",this.onChangeQuestion,this),this.on("change:questionHeight",(function(){this.attr(".options/refY",130,{silent:!0})}),this),this.attr(".options/refY",130,{silent:!0}),this.attr("#question-text/text",this.get("question").text,{silent:!0}),this.onChangeOptions()},onChangeQuestion:function(){let t=this.get("question"),e=t.active?"#FFF0BC":"#ffd6d6";null!=this.getPorts()[0].attrs&&this.getPorts()[0].attrs.circle.fill==e||this.portProp(this.getPorts()[0].id,"attrs/circle/fill",e);let i=joint.util.measureText(t.text);i!=this.attr("#question-text/text")&&this.attr("#question-text/text",i)},onChangeOptions:function(){var t=this.get("options"),e=0,i={};_.each(t,function(t){var n=".option-"+t.id;i[n]={transform:"translate(0, "+e+")",dynamic:!0},i[n+" .option-rect"]={height:30,dynamic:!0},i[n+" .option-text"]={text:joint.util.measureText(t.text),dynamic:!0,refY:15},e+=30;var o=(e+=2)-15+130-2;this.getPort(t.id)?(this.portProp(t.id,"args/y",o),this.portProp(t.id,"attrs/circle/fill",t.active?"#FFF0BC":"#ffd6d6")):this.addPort({group:"out",id:t.id,args:{y:o}})}.bind(this)),this.attr(i),this.autoresize()},autoresize:function(){var t=this.get("options")||[],e=30*t.length+130+35+2*t.length;this.resize(235,e)},applyEdit:function(t){commandManager.initBatchCommand(),_.each(t.remove,function(t){this.removePort(t)}.bind(this)),this.set("options",t.answers),this.set("question",t.question),commandManager.storeBatchCommand()},addOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));e.push(t),this.set("options",e),commandManager.storeBatchCommand()},removeOption:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("options")));this.removePort(t),this.set("options",_.without(e,_.find(e,{id:t}))),commandManager.storeBatchCommand()},changeOptionActivity:function(t,e){commandManager.initBatchCommand();var i=JSON.parse(JSON.stringify(this.get("options")));i[_.findIndex(i,{id:t})].active=e,this.set("options",i),commandManager.storeBatchCommand()},changeQuestionActivity:function(t){commandManager.initBatchCommand();var e=JSON.parse(JSON.stringify(this.get("question")));e.active=t,this.set("question",e),commandManager.storeBatchCommand()}})}InitQuestion(),joint.shapes.qad.QuestionView=joint.dia.ElementView.extend({events:{"click #add-answer image":"onAddOption","click .btn-remove-option":"onRemoveOption"},presentationAttributes:joint.dia.ElementView.addPresentationAttributes({options:["OPTIONS"]}),confirmUpdate:function(t){joint.dia.ElementView.prototype.confirmUpdate.apply(this,arguments),this.hasFlag(t,"OPTIONS")&&this.renderOptions()},renderMarkup:function(){joint.dia.ElementView.prototype.renderMarkup.apply(this,arguments),this.$options=this.$(".options"),this.elOption=V(this.model.optionMarkup),this.renderOptions()},renderOptions:function(){this.$options.empty(),_.each(this.model.get("options"),function(t,e){var i="option-"+t.id,n=this.elOption.clone().addClass(i);n.attr("option-id",t.id),this.$options.append(n.node)}.bind(this)),this.update()},onAddOption:function(){this.model.addOption({id:_.uniqueId("option-"),text:"Answer "+(this.model.get("options").length+1),active:!1})},onRemoveOption:function(t){this.model.removeOption(V(t.target.parentNode).attr("option-id"))}}),app.Selection=Backbone.Collection.extend(),app.SelectionView=joint.mvc.View.extend({PADDING:3,BOX_TEMPLATE:V("rect",{stroke:"#C6C7E2","stroke-width":1,"pointer-events":"none"}),init:function(){this.listenTo(this.model,"add reset change",this.render)},render:function(){return _.invokeMap(this.boxes,"remove"),this.boxes=this.model.map(function(t){return this.BOX_TEMPLATE.clone().attr(t.getBBox().inflate(this.PADDING)).appendTo(this.options.paper.cells)}.bind(this)),this},onRemove:function(){_.invokeMap(this.boxes,"remove"),delete this.boxes}}),app.Factory={createQuestion:function(t,e){return new joint.shapes.qad.Question({ports:{items:e?[]:[{group:"in"}]},attrs:{"#header-logo":{display:e?"block":"none"}},position:{x:350,y:30},question:{text:t,active:!1},start:e,options:[]})},createLink:function(){return new joint.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"#6a6c8a",stroke:"#6a6c8a"},".connection":{stroke:"#6a6c8a",strokeWidth:2}}})},createDialogJSON:function(t,e){var i={startNode:void 0,nodes:[],links:[]};return _.each(t.getCells(),(function(t){var n={id:t.id,type:t.get("type")};switch(t.get("type")){case"qad.Question":n.question=t.get("question"),n.options=t.get("options"),i.nodes.push(n),e?e==t.id&&(i.startNode=i.nodes.length-1):t.get("start")&&(i.startNode=i.nodes.length-1);break;default:n.source=t.get("source"),n.target=t.get("target"),i.links.push(n)}})),i}};let modePlay=new ModePlay;function ModePlay(){let t=this,e=document.querySelector(".mode-start"),i=e.querySelector(".mode-start__answer"),n=e.querySelector(".mode-start__questions_text"),o=e.querySelector(".mode-start__header_close");function a(){r(!1)}function r(t){e.style.display=t?"flex":"none"}function s(e,o){t.dataNodes=e,o||(o=e.nodes[e.startNode]),function(t){i.textContent="";for(var e=0;e<t.options.length;e++)i.appendChild(d(t.options[e]));n.innerHTML=t.question.text}(o),t.currentNode=o}function d(e){var i,n,o,a=(i="div",n="mode-start__answer_item",(o=document.createElement(i)).setAttribute("class",n),o);a.textContent=e.text;let r=e.id;return a.onclick=function(){!function(e){for(var i,n=0;n<t.dataNodes.links.length;n++){var o=t.dataNodes.links[n];if(o.source.id===t.currentNode.id&&o.source.port===e){i=o;break}}if(i){for(var a,r=0;r<t.dataNodes.nodes.length;r++){var d=t.dataNodes.nodes[r];if(d.id===i.target.id){a=d;break}}a&&s(t.dataNodes,a)}}(r)},a}this.Initialize=function(){o.onclick=a},this.openDialog=function(t,e){let i=app.Factory.createDialogJSON(t,e);i.nodes.length>1&&i.links.length>0&&(r(!0),s(i))}}modePlay.Initialize(),app.AppView=joint.mvc.View.extend({el:".board",events:{"click .board__create-node":"addQuestion","click .board__start":"previewDialog","click #toolbar .code-snippet":"showCodeSnippet","click #toolbar .load-example":"loadExample","click #toolbar .clear":"clear"},init:function(){this.initializePaper()},initializePaper:function(){joint.linkTools.mapping={Remove:joint.linkTools.Button.extend({children:[{tagName:"circle",selector:"button",attributes:{r:10,fill:"#f6f6f6",stroke:"#5755a1","stroke-width":2,cursor:"pointer"}},{tagName:"path",selector:"icon",attributes:{d:"M -4 -4 4 4 M -4 4 4 -4",fill:"none",stroke:"#5755a1","stroke-width":4,"pointer-events":"none"}}]})},joint.shapes.standard.Link.define("mapping.Link",{z:-1,attrs:{line:{targetMarker:{type:"path",fill:"#5755a1",d:"M 10 -5 0 0 10 5 z"},stroke:"gray"}}}),this.paper=new joint.dia.Paper({el:this.$("#paper"),width:1500,height:500,gridSize:10,snapLinks:{radius:10},interactive:{vertexAdd:!1,arrowheadMove:!1,useLinkTools:!1},linkPinning:!1,multiLinks:!1,defaultLink:function(){return new joint.shapes.mapping.Link},defaultRouter:{name:"manhattan",args:{padding:10,maxAllowedDirectionChange:180,perpendicular:!1,startDirections:["right"],endDirections:["left","right"],maximumLoops:2e3}},defaultConnector:{name:"rounded",args:{radius:7}},validateConnection:function(t,e,i,n,o,a){return(!e||"in"!==e.getAttribute("port-group"))&&(t!==i&&(n&&"in"===n.getAttribute("port-group")||"qad.Question"===t.model.get("type")&&"qad.Answer"===i.model.get("type")))},validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")}});var t=new joint.ui.PaperScroller({autoResizePaper:!0,padding:1e3,paper:this.paper,cursor:"grab"});function e(e,i,n){t.zoom(.15*n,{min:.4,max:2.5,grid:.1,ox:e,oy:i})}function i(e){t.zoom(.4*e,{min:.4,max:2.5})}function n(t,e){commandManager.initBatchCommand(),e.targetView.model.changeQuestionActivity(!1),e.sourceView.model.changeOptionActivity(e.sourceMagnet.getAttribute("port"),!1),t.remove(),commandManager.storeBatchCommand()}t.lock(),this.paper.on("blank:pointerdown",t.startPanning),$("#app").append(t.render().el),this.paper.on("link:mouseenter",(function(t){this.removeTools(),function(t){var e=new joint.dia.ToolsView({tools:[new joint.linkTools.mapping.Remove({distance:"92%",action:function(){n(this.model,t)}}),new joint.linkTools.mapping.Remove({distance:"8%",action:function(){n(this.model,t)}})]});t.addTools(e)}(t)})),this.paper.on("blank:mousewheel",(function(t,i,n,o){t.preventDefault(),e(i,n,o)})),this.paper.on("cell:mousewheel",(function(t,i,n,o,a){i.preventDefault(),e(n,o,a)})),$(".zoom-in").on("click",(function(){i(1)})),$(".zoom-out").on("click",(function(){i(-1)})),this.paper.on("link:mouseleave",(function(){this.removeTools()})),this.paper.defs.innerHTML='<filter id="dropshadow"><feDropShadow dx="0" dy="5" stdDeviation="4" flood-color="#000000" flood-opacity="0.25"/></filter>',this.paper.on("link:snap:connect",(function(t,e){e.stopPropagation(),t.targetView.model.changeQuestionActivity(!0),t.sourceView.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!0),console.log("link:snap:connect")})),this.paper.on("link:snap:disconnect",(function(t,e,i,n,o){e.stopPropagation(),null==t.targetView&&(i.model.changeQuestionActivity(!1),t.sourceView.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!1)),console.log("link:snap:disconnect")})),this.graph=this.paper.model,commandManager=new joint.dia.CommandManager({graph:this.graph}),$(".undo").click((function(){commandManager.undo()})),$(".redo").click((function(){commandManager.redo()})),this.paper.on("element:delete",(function(t,e,i,n){e.stopPropagation(),t.model.remove()})),this.paper.on("element:edit",(function(t,e,i,n){e.stopPropagation(),editNodeWindow.SetListItems(t.model)})),this.paper.on("element:play",(function(t,e,i,n){e.stopPropagation(),modePlay.openDialog(this.graph,t.model.id)}),this)},addQuestion:function(){let t=!0;_.each(this.graph.attributes.cells.models,function(e){if(e.attributes.start)return t=!1,!1}.bind(this)),app.Factory.createQuestion("Question",t).addTo(this.graph)},previewDialog:function(){modePlay.openDialog(this.graph)},clear:function(){this.graph.clear()},showCodeSnippet:function(){var t=this.selection.first(),e=app.Factory.createDialogJSON(this.graph,t),i=_.uniqueId("qad-dialog-"),n="";n+='<div id="'+i+'"></div>',n+='<link rel="stylesheet" type="text/css" href="http://qad.client.io/css/snippet.css"><\/script>',n+='<script type="text/javascript" src="http://qad.client.io/src/snippet.js"><\/script>',n+='<script type="text/javascript">',n+='document.getElementById("'+i+'").appendChild(qad.renderDialog('+JSON.stringify(e)+"))";var o="<textarea>"+(n+="<\/script>")+"</textarea>";new joint.ui.Dialog({width:"50%",height:200,draggable:!0,title:"Copy-paste this snippet to your HTML page.",content:o}).open()}}),joint.util.measureText=function(t){var e=V("svg").node,i=V("<text><tspan></tspan></text>").node,n=i.firstChild,o=document.createTextNode("");n.appendChild(o),e.appendChild(i),document.body.appendChild(e),o.data=t;var a=n.getBBox().width;if(a>143){let i=t.split(""),r="";for(let t=0;t<i.length;t++)if(r+=i[t],o.data=r,(a=n.getBBox().width)>=143)return V(e).remove(),r+"..."}return V(e).remove(),t};let editNodeWindow=new EditNodeWindow;function EditNodeWindow(){let t,e,i,n,o=0,a=document.querySelector(".node-edit"),r=a.querySelector(".node-edit__wrapper-item"),s=a.querySelector(".node-edit__header_btn"),d=document.querySelector("body"),l=new function(){let t;this.data={question:{text:""}},this.Initialize=function(e){t=e,this.data={question:JSON.parse(JSON.stringify(e.get("question"))),answers:JSON.parse(JSON.stringify(e.get("options"))),remove:[]}},this.ApplyEdit=function(){t.applyEdit(this.data)},this.addAnswer=function(){let t={id:_.uniqueId("option-"),text:"",active:!1};return t.text=t.id,this.data.answers.push(t),t},this.removeAnswer=function(t){this.data.answers=_.without(this.data.answers,_.find(this.data.answers,{id:t})),this.data.remove.push(t)}};function c(){r.innerHTML="",i=null,e=0}function p(i){e++;let n=t.cloneNode(!0);function o(){e>=3?r.classList.add("activeScroll"):r.classList.remove("activeScroll")}r.appendChild(n),n.querySelector(".node-edit__remove-item").onclick=function(t){t.stopPropagation(),e--,this.parentNode.remove(),o(),l.removeAnswer(i.id)},u(n,i),o()}function h(t){a.style.display=t?"flex":"none",d.style.overflowY=t?"hidden":"scroll"}function u(t,e){let n=t.querySelector(".node-edit__item"),a=n.querySelector(".node-edit__item_text"),r=n.querySelector(".node-edit__control_start"),s=n.querySelector(".node-edit__control_cancel"),d="";function l(){n.style.height=a.offsetHeight+"px"}function c(t){a.value=h(t),d=e.text,e.text=t}function p(){t.classList.remove("excretionItem")}function h(t){let e,i,n=t.split(" ");!function(){let t=getComputedStyle(a);o=Math.max(o,a.offsetWidth-(parseInt(t.paddingLeft)+parseInt(t.paddingRight))),e=parseInt(t.lineHeight),i=document.createElement("p"),i.style.lineHeight=e+"px",i.style.fontSize=t.fontSize,i.style.fontFamily=t.fontFamily,i.style.display="inline-block",document.body.appendChild(i)}();let r=function(t){if(s(t)>3){let t="",e="";return function(){for(;;){let e=t+n[0]+" ";if(3==s(e))break;n.shift(),t=e}}(),function(){for(;e+=n.shift()+" ",4!=s(t+e););}(),function(){let t=e.split("");e="";for(let n=0;n<t.length;n++){let a=e+t[n];if(d(a)>=o-13){" "==t[n-1]&&(i(),"."==t[n-2]&&i()),"."==t[n-1]&&i();break}e=a}function i(){e=e.slice(0,-1)}}(),t+e+"..."}return t}(t);return i.remove(),r;function s(t){return l(t,!0),i.offsetHeight/e}function d(t){return l(t,!1),i.offsetWidth}function l(t,e){i.innerText=t,i.style.width=e?o+"px":"auto"}}autosize(a),a.addEventListener("autosize:resized",l),s.onclick=function(t){console.log("buttonCancel"),a.value=h(d),e.text=d},a.onfocus=function(n){null!=i&&p(),i=t,t.classList.add("excretionItem"),a.value=e.text,r.style.right="75px",s.style.right="5px",autosize.update(a),l(),console.log("onfocus")},a.onblur=function(t){p(),c(a.value),r.style.right="-75px",s.style.right="-145px",autosize.update(a),l(),console.log("onblur")},c(e.text)}this.Initialize=function(){!function(){let e=r.querySelector(".node-edit__inner-item");t=e.cloneNode(!0),c()}(),a.querySelector(".node-edit__add-item").onclick=function(){p(l.addAnswer())},n=document.querySelector(".node-edit__operator").querySelector(".node-edit__inner-item"),s.onclick=function(){l.ApplyEdit(),h(!1)}},this.SetListItems=function(t){l.Initialize(t),modelGeneral=t,c(),function(){_.each(l.data.answers,function(t){p(t)}.bind(this))}(),h(!0),u(n,l.data.question)}}editNodeWindow.Initialize(),window.appView=new app.AppView,joint.setTheme("modern");