var app=app||{},qad=window.qad||{};function InitQuestion(){joint.dia.Element.define("qad.Question",{ports:{groups:{in:{id:"in",position:{name:"left",args:{y:"60"}},attrs:{circle:{magnet:"passive",stroke:"#b6b6b6",strokeWidth:2,fill:"#ffd6d6",r:10},text:{pointerEvents:"none",fontSize:12},itemHighlight:{fill:"#fff"}},markup:'<circle id="port-in"/>',label:{markup:'<image width="13" height="8" style="transform: matrix(-1,0,0,1,6,-8)" xlink:href="img/board/fork.svg"></image>'}},out:{position:{args:{x:235}},attrs:{circle:{magnet:!0,stroke:"#b6b6b6",fill:"#ffd6d6",strokeWidth:2,r:10},image:{pointerEvents:"none"}},label:{position:{args:{x:-6,y:-8}},markup:'<image width="12" height="8" xlink:href="img/board/fork.svg"></image>'},markup:"<circle/>"}}},attrs:{".":{magnet:!1},"#main-back":{fill:"#e2f7dc",refWidth:"100%",refHeight:"100%",filter:"url(#dropshadow)",rx:"5",ry:"5"},"#header #play":{x:113,y:2,width:16,height:19,cursor:"pointer"},"#header #remove":{event:"element:delete",x:216,y:8,width:10,height:9,cursor:"pointer"},"#header text":{x:7,y:16},"#header-logo":{display:"block"},"#header-logo rect":{fill:"#f2f2f2",refX:"50%",refX2:"-50",y:"-25",width:100,height:"50",rx:"5",ry:"5",strokeWidth:2,stroke:"black"},"#header-logo text":{x:86,y:-7,fontSize:14,fontWeight:600},"#body rect":{fill:"#e4f3ff",y:23,refWidth:"-6",x:3,height:71},"#body #edit":{event:"element:edit",x:9,y:32,width:13,height:13,cursor:"pointer"},"#body #title-question":{x:25,y:53,fontSize:14,fontWeight:600},"#body #question-text":{x:25,y:73,fontSize:14},"#footer #title-footer":{x:25,y:116,fontSize:14,fontWeight:600},"#footer rect":{fill:"#B6B6B6",x:3,y:128,refWidth:"-6",refHeight:-163,z:-1},"#add-answer text":{refX:31,refDy:-14,fontSize:12},"#add-answer image":{refX:"50%",refX2:"-13",refDy:-31,height:26,width:26,cursor:"pointer"},".btn-remove-option":{height:20,width:20,x:3,y:5,cursor:"pointer"},".options":{refX:0},text:{fontFamily:"Roboto-Regular"},".option-text":{fontSize:13,fill:"#4b4a67",refX:30,yAlignment:"middle"},".option-rect":{fill:"#e2f7dc",width:235}}},{markup:['<g id="header-logo">',"<rect/>","<text>Start node</text>","</g>",'<rect id="main-back" />','<g id="header">','<text font-size="14">node #1</text>','<image id="play" xlink:href="img/board/Play.svg"/>','<image id="remove" xlink:href="img/board/cross.svg"/>',"</g>",'<g id="body">',"<rect/>",'<image id="edit" xlink:href="img/board/pen.svg"/>','<text id="title-question"> Operator phrase: </text>','<text id="question-text"/>',"</g>",'<g id="footer">',"<rect/>",'<text id="title-footer">Response:</text>','<g id="add-answer">',"<text>Add answer</text>",'<image xlink:href="img/board/add-answer.svg"/>',"</g>","</g>",'<g class="options"></g>'].join(""),optionMarkup:['<g class="option">','<rect class="option-rect" />','<image class="btn-remove-option" xlink:href="img/board/btn-remove.svg"/>','<text class="option-text"/>',"</g>"].join(""),initialize:function(){joint.dia.Element.prototype.initialize.apply(this,arguments),this.on("change:options",this.onChangeOptions,this),this.on("change:question",this.onChangeQuestion,this),this.on("change:questionHeight",(function(){this.attr(".options/refY",130,{silent:!0})}),this),this.attr(".options/refY",130,{silent:!0}),this.attr("#question-text/text",this.get("question").text,{silent:!0}),this.onChangeOptions()},onChangeQuestion:function(){var t=this.get("question");this.attributes.ports.groups.in.attrs.circle.fill=t.active?"#FFF0BC":"#ffd6d6",this.attr("#question-text/text",joint.util.measureText(t.text))},onChangeOptions:function(){var t=this.get("options"),e=0,i={};_.each(t,function(t){var n=".option-"+t.id;i[n]={transform:"translate(0, "+e+")",dynamic:!0},i[n+" .option-rect"]={height:30,dynamic:!0},i[n+" .option-text"]={text:joint.util.measureText(t.text),dynamic:!0,refY:15},e+=30;var o=(e+=2)-15+130-2;this.getPort(t.id)?(this.portProp(t.id,"args/y",o),this.portProp(t.id,"attrs/circle/fill",t.active?"#FFF0BC":"#ffd6d6")):this.addPort({group:"out",id:t.id,args:{y:o}})}.bind(this)),this.attr(i),this.autoresize()},autoresize:function(){var t=this.get("options")||[],e=30*t.length+130+35+2*t.length;this.resize(235,e)},applyEdit:function(t){_.each(t.remove,function(t){this.removePort(t)}.bind(this)),this.set("options",t.answers),this.set("question",t.question)},addOption:function(t){var e=JSON.parse(JSON.stringify(this.get("options")));e.push(t),this.set("options",e)},removeOption:function(t){var e=JSON.parse(JSON.stringify(this.get("options")));this.removePort(t),this.set("options",_.without(e,_.find(e,{id:t})))},changeOption:function(t,e){e.id||(e.id=t);var i=JSON.parse(JSON.stringify(this.get("options")));i[_.findIndex(i,{id:t})]=e,this.set("options",i)},changeOptionActivity:function(t,e){var i=JSON.parse(JSON.stringify(this.get("options")));i[_.findIndex(i,{id:t})].active=e,this.set("options",i)},changeQuestionActivity:function(t){var e=JSON.parse(JSON.stringify(this.get("question")));e.active=t,this.set("question",e)}})}InitQuestion(),joint.shapes.qad.QuestionView=joint.dia.ElementView.extend({events:{"click #add-answer image":"onAddOption","click .btn-remove-option":"onRemoveOption"},presentationAttributes:joint.dia.ElementView.addPresentationAttributes({options:["OPTIONS"]}),confirmUpdate:function(t){joint.dia.ElementView.prototype.confirmUpdate.apply(this,arguments),this.hasFlag(t,"OPTIONS")&&this.renderOptions()},renderMarkup:function(){joint.dia.ElementView.prototype.renderMarkup.apply(this,arguments),this.$options=this.$(".options"),this.elOption=V(this.model.optionMarkup),this.renderOptions()},renderOptions:function(){this.$options.empty(),_.each(this.model.get("options"),function(t,e){var i="option-"+t.id,n=this.elOption.clone().addClass(i);n.attr("option-id",t.id),this.$options.append(n.node)}.bind(this)),this.update()},onAddOption:function(){this.model.addOption({id:_.uniqueId("option-"),text:"Answer "+(this.model.get("options").length+1),active:!1})},onRemoveOption:function(t){this.model.removeOption(V(t.target.parentNode).attr("option-id"))}}),app.Selection=Backbone.Collection.extend(),app.SelectionView=joint.mvc.View.extend({PADDING:3,BOX_TEMPLATE:V("rect",{stroke:"#C6C7E2","stroke-width":1,"pointer-events":"none"}),init:function(){this.listenTo(this.model,"add reset change",this.render)},render:function(){return _.invokeMap(this.boxes,"remove"),this.boxes=this.model.map(function(t){return this.BOX_TEMPLATE.clone().attr(t.getBBox().inflate(this.PADDING)).appendTo(this.options.paper.cells)}.bind(this)),this},onRemove:function(){_.invokeMap(this.boxes,"remove"),delete this.boxes}}),app.Factory={createQuestion:function(t,e){return new joint.shapes.qad.Question({ports:{items:e?[]:[{group:"in"}]},attrs:{"#header-logo":{display:e?"block":"none"}},position:{x:350,y:30},question:{text:t,active:!1},start:e,options:[]})},createLink:function(){return new joint.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"#6a6c8a",stroke:"#6a6c8a"},".connection":{stroke:"#6a6c8a",strokeWidth:2}}})},createDialogJSON:function(t,e){var i={root:void 0,nodes:[],links:[]};return _.each(t.getCells(),(function(e){var n={id:e.id,type:e.get("type")};switch(e.get("type")){case"qad.Question":n.question=e.get("question"),n.options=e.get("options"),i.nodes.push(n);break;default:n.source=e.get("source"),n.target=e.get("target"),i.links.push(n)}e.isLink()||t.getConnectedLinks(e,{inbound:!0}).length||(i.root=e.id)})),e&&(i.root=e.id),i}},qad.renderDialog=function(t,e){if(this.dialog=t,!e)for(var i=0;i<t.nodes.length;i++)if(t.nodes[i].id===t.root){e=t.nodes[i];break}if(!e)throw new Error("It is not clear where to go next.");switch(this.el||(this.el=this.createElement("div","qad-dialog")),this.el.textContent="",e.type){case"qad.Question":this.renderQuestion(e);break;case"qad.Answer":this.renderAnswer(e)}return this.currentNode=e,this.el},qad.createElement=function(t,e){var i=document.createElement(t);return i.setAttribute("class",e),i},qad.renderOption=function(t){var e=this.createElement("button","qad-option qad-button");e.textContent=t.text,e.setAttribute("data-option-id",t.id);var i=this;return e.addEventListener("click",(function(t){i.onOptionClick(t)}),!1),e},qad.renderQuestion=function(t){for(var e=this.createElement("div","qad-content"),i=this.createElement("div","qad-options"),n=0;n<t.options.length;n++)i.appendChild(this.renderOption(t.options[n]));var o=this.createElement("h3","qad-question-header");o.innerHTML=t.question,e.appendChild(o),e.appendChild(i),this.el.appendChild(e)},app.AppView=joint.mvc.View.extend({el:"#app",events:{"click .board__create-node":"addQuestion","click #toolbar .preview-dialog":"previewDialog","click #toolbar .code-snippet":"showCodeSnippet","click #toolbar .load-example":"loadExample","click #toolbar .clear":"clear"},init:function(){this.initializePaper()},initializePaper:function(){function t(t,e){e.targetView.model.changeQuestionActivity(!1),e.sourceView.model.changeOptionActivity(e.sourceMagnet.getAttribute("port"),!1),e.targetMagnet.style.fill="#ffd6d6",t.remove()}joint.linkTools.mapping={Remove:joint.linkTools.Button.extend({children:[{tagName:"circle",selector:"button",attributes:{r:10,fill:"#f6f6f6",stroke:"#5755a1","stroke-width":2,cursor:"pointer"}},{tagName:"path",selector:"icon",attributes:{d:"M -4 -4 4 4 M -4 4 4 -4",fill:"none",stroke:"#5755a1","stroke-width":4,"pointer-events":"none"}}]})},joint.shapes.standard.Link.define("mapping.Link",{z:-1,attrs:{line:{targetMarker:{type:"path",fill:"#5755a1",d:"M 10 -5 0 0 10 5 z"},stroke:"gray"}}}),this.paper=new joint.dia.Paper({el:this.$("#paper"),width:"100%",height:"100%",gridSize:10,snapLinks:{radius:10},interactive:{vertexAdd:!1,arrowheadMove:!1,useLinkTools:!1},linkPinning:!1,multiLinks:!1,defaultLink:function(){return new joint.shapes.mapping.Link},defaultRouter:{name:"manhattan",args:{padding:10,maxAllowedDirectionChange:180,perpendicular:!1,startDirections:["right"],endDirections:["left","right"],maximumLoops:2e3}},defaultConnector:{name:"rounded",args:{radius:7}},validateConnection:function(t,e,i,n,o,r){return(!e||"in"!==e.getAttribute("port-group"))&&(t!==i&&(n&&"in"===n.getAttribute("port-group")||"qad.Question"===t.model.get("type")&&"qad.Answer"===i.model.get("type")))},validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")}}),this.paper.on("link:mouseenter",(function(e){this.removeTools(),function(e){var i=new joint.dia.ToolsView({tools:[new joint.linkTools.mapping.Remove({distance:"92%",action:function(){t(this.model,e)}}),new joint.linkTools.mapping.Remove({distance:"8%",action:function(){t(this.model,e)}})]});e.addTools(i)}(e)})),this.paper.on("link:mouseleave",(function(){this.removeTools()})),this.paper.defs.innerHTML='<filter id="dropshadow"><feDropShadow dx="0" dy="5" stdDeviation="4" flood-color="#000000" flood-opacity="0.25"/></filter>',this.paper.on("link:snap:connect",(function(t,e){e.stopPropagation(),t.targetView.model.changeQuestionActivity(!0),t.sourceView.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!0),t.targetMagnet.style.fill="#FFF0BC"})),this.paper.on("link:snap:disconnect",(function(t,e,i,n,o){null==t.targetView?(i.model.changeQuestionActivity(!1),t.sourceView.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!1),n.style.fill="#ffd6d6"):(t.targetView.model.changeQuestionActivity(!1),lelementViewDisconnected.model.changeOptionActivity(t.sourceMagnet.getAttribute("port"),!1),t.sourceMagnet.style.fill="#ffd6d6")})),this.graph=this.paper.model,this.paper.on("element:delete",(function(t,e,i,n){e.stopPropagation(),t.model.remove()})),this.paper.on("element:edit",(function(t,e,i,n){e.stopPropagation(),editNodeWindow.SetListItems(t.model)}))},addQuestion:function(){let t=!0;_.each(this.graph.attributes.cells.models,function(e){if(e.attributes.start)return t=!1,!1}.bind(this)),app.Factory.createQuestion("Question",t).addTo(this.graph)},previewDialog:function(){var t=this.selection.first(),e=app.Factory.createDialogJSON(this.graph,t),i=$("<div/>").addClass("background").on("click",(function(){$("#preview").empty()}));$("#preview").empty().append([i,qad.renderDialog(e)]).show()},clear:function(){this.graph.clear()},showCodeSnippet:function(){var t=this.selection.first(),e=app.Factory.createDialogJSON(this.graph,t),i=_.uniqueId("qad-dialog-"),n="";n+='<div id="'+i+'"></div>',n+='<link rel="stylesheet" type="text/css" href="http://qad.client.io/css/snippet.css"><\/script>',n+='<script type="text/javascript" src="http://qad.client.io/src/snippet.js"><\/script>',n+='<script type="text/javascript">',n+='document.getElementById("'+i+'").appendChild(qad.renderDialog('+JSON.stringify(e)+"))";var o="<textarea>"+(n+="<\/script>")+"</textarea>";new joint.ui.Dialog({width:"50%",height:200,draggable:!0,title:"Copy-paste this snippet to your HTML page.",content:o}).open()}}),joint.util.measureText=function(t){var e=V("svg").node,i=V("<text><tspan></tspan></text>").node,n=i.firstChild,o=document.createTextNode("");n.appendChild(o),e.appendChild(i),document.body.appendChild(e),o.data=t;var r=n.getBBox().width;if(r>143){let i=t.split(""),s="";for(let t=0;t<i.length;t++)if(s+=i[t],o.data=s,(r=n.getBBox().width)>=143)return V(e).remove(),s+"..."}return V(e).remove(),t};let editNodeWindow=new EditNodeWindow;function EditNodeWindow(){let t,e,i,n,o=0,r=document.querySelector(".node-edit"),s=r.querySelector(".node-edit__wrapper-item"),a=r.querySelector(".node-edit__header_btn"),d=document.querySelector("body"),l=new function(){let t;this.data={question:{text:""}},this.Initialize=function(e){t=e,this.data={question:JSON.parse(JSON.stringify(e.get("question"))),answers:JSON.parse(JSON.stringify(e.get("options"))),remove:[]}},this.ApplyEdit=function(){t.applyEdit(this.data)},this.addAnswer=function(){let t={id:_.uniqueId("option-"),text:"",active:!1};return t.text=t.id,this.data.answers.push(t),t},this.removeAnswer=function(t){this.data.answers=_.without(this.data.answers,_.find(this.data.answers,{id:t})),this.data.remove.push(t)}},c=new function(){let t,e=document.querySelector(".editing"),i=e.querySelector("textarea"),n=e.querySelector(".editing__control_start"),o=e.querySelector(".editing__control_cancel");this.Edition=function(e,r,s){i.value=e,t=s,n.onclick=function(){r(i.value)},o.onclick=this.Discharge},this.Discharge=function(){i.value="",n.onclick=null,o.onclick=null,null!=t&&t(),t=null}};function p(){s.innerHTML="",i=null,e=0}function h(i){e++;let n=t.cloneNode(!0);function o(){e>=3?s.classList.add("activeScroll"):s.classList.remove("activeScroll")}s.appendChild(n),n.querySelector(".node-edit__remove-item").onclick=function(t){t.stopPropagation(),e--,this.parentNode.remove(),o(),l.removeAnswer(i.id)},f(n,i),o()}function u(t){r.style.display=t?"flex":"none",d.style.overflowY=t?"hidden":"scroll"}function f(t,e){let n=t.querySelector(".node-edit__item_text");function r(t){n.innerText=function(t){let e;o=Math.max(o,n.offsetWidth);let i,r=t.split(" ");!function(){let t=getComputedStyle(n);e=parseInt(t.lineHeight),i=document.createElement("p"),i.style.lineHeight=e+"px",i.style.fontSize=t.fontSize,i.style.fontFamily=t.fontFamily,i.style.display="inline-block",document.body.appendChild(i)}();let s=function(t){if(a(t)>3){let t="",e="";return function(){for(;;){let e=t+r[0]+" ";if(3==a(e))break;r.shift(),t=e}}(),function(){for(;e+=r.shift()+" ",4!=a(t+e););}(),function(){let t=e.split("");e="";for(let n=0;n<t.length;n++){let r=e+t[n];if(d(r)>=o-13){" "==t[n-1]&&(i(),"."==t[n-2]&&i()),"."==t[n-1]&&i();break}e=r}function i(){e=e.slice(0,-1)}}(),t+e+"..."}return t}(t);return i.remove(),s;function a(t){return l(t,!0),i.offsetHeight/e}function d(t){return l(t,!1),i.offsetWidth}function l(t,e){i.innerText=t,i.style.width=e?o+"px":"auto"}}(t),e.text=t}function s(){i.classList.remove("excretionItem"),i=null}t.onclick=function(n){n.stopPropagation(),null!=i&&s(),i=this,t.classList.add("excretionItem"),c.Edition(e.text,r,s)},r(e.text)}this.Initialize=function(){!function(){let e=s.querySelector(".node-edit__inner-item");e.querySelector(".node-edit__item_text").offsetWidth,t=e.cloneNode(!0),p()}(),r.querySelector(".node-edit__add-item").onclick=function(){h(l.addAnswer())},n=document.querySelector(".node-edit__operator").querySelector(".node-edit__inner-item"),a.onclick=function(){c.Discharge(),l.ApplyEdit(),u(!1)}},this.SetListItems=function(t){l.Initialize(t),modelGeneral=t,p(),function(){_.each(l.data.answers,function(t){h(t)}.bind(this))}(),u(!0),f(n,l.data.question)}}editNodeWindow.Initialize(),window.appView=new app.AppView,joint.setTheme("modern"),autosize(document.querySelector("textarea"));